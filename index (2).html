<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Study Analysis Tool - NACTO City Limits</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Leaflet Map Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        :root {
            --primary: #1a5f7a;
            --primary-dark: #134a5e;
            --secondary: #57837b;
            --accent: #c38154;
            --accent-light: #e8a87c;
            --light: #f9e2af;
            --white: #ffffff;
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #e5e5e5;
            --gray-300: #d4d4d4;
            --gray-600: #525252;
            --gray-800: #262626;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --info: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.05);
            }
        }

        .vdot-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #1a5f7a;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
            vertical-align: middle;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-vdot-fetch {
            background: #f0f9ff;
            color: #1a5f7a;
            border: 1px solid #bae6fd;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .btn-vdot-fetch:hover {
            background: #e0f2fe;
            border-color: #1a5f7a;
        }

        .vdot-legend {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #e2e8f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(26, 95, 122, 0.5);
            }

            50% {
                box-shadow: 0 0 20px rgba(26, 95, 122, 0.8);
            }
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, var(--white) 0%, var(--gray-50) 100%);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: fadeInUp 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 3s infinite;
        }

        .header h1 {
            color: var(--primary);
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .header p {
            color: var(--gray-600);
            font-size: 1.2rem;
        }

        .badge-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            animation: fadeIn 1s ease-out 0.3s both;
        }

        .badge-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .badge-accent {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
            animation: fadeInUp 0.6s ease-out;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.2);
        }

        .card:nth-child(odd) {
            animation: slideInLeft 0.6s ease-out;
        }

        .card:nth-child(even) {
            animation: slideInRight 0.6s ease-out;
        }

        .card-title {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid transparent;
            border-image: linear-gradient(90deg, var(--primary), var(--accent)) 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-title svg {
            width: 30px;
            height: 30px;
            animation: bounce 2s infinite;
        }

        .form-group {
            margin-bottom: 22px;
            animation: fadeIn 0.5s ease-out;
        }

        .form-group label {
            display: block;
            color: var(--gray-600);
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--gray-50);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(26, 95, 122, 0.15);
            background: var(--white);
            transform: scale(1.01);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--gray-300);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 18px;
        }

        @media (max-width: 768px) {

            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #16a34a);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--accent), #a66d42);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info), #2563eb);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--gray-600), var(--gray-800));
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 25px;
        }

        .checklist-section {
            background: linear-gradient(135deg, var(--gray-50), var(--gray-100));
            border-radius: 16px;
            padding: 22px;
            margin-bottom: 22px;
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .checklist-section:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .checklist-section h4 {
            color: var(--primary);
            margin-bottom: 18px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 14px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .checklist-item:hover {
            border-color: var(--primary);
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .checklist-item.checked {
            background: linear-gradient(135deg, rgba(26, 95, 122, 0.1), rgba(87, 131, 123, 0.1));
            border-color: var(--primary);
        }

        .checklist-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            margin-top: 2px;
            accent-color: var(--primary);
        }

        .checklist-item label {
            flex: 1;
            cursor: pointer;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .result-box {
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            margin: 25px 0;
            transition: all 0.5s ease;
            animation: fadeIn 0.5s ease-out;
        }

        .result-high {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
            box-shadow: 0 10px 40px rgba(238, 90, 90, 0.4);
        }

        .result-moderate {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1f2937;
            box-shadow: 0 10px 40px rgba(245, 158, 11, 0.4);
        }

        .result-low {
            background: linear-gradient(135deg, #34d399, #22c55e);
            color: white;
            box-shadow: 0 10px 40px rgba(34, 197, 94, 0.4);
        }

        .result-box h3 {
            font-size: 1.8rem;
            margin-bottom: 12px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .result-box p {
            font-size: 1.05rem;
            opacity: 0.95;
        }

        .speed-limit-display {
            background: linear-gradient(135deg, var(--primary), #0d3d4d);
            color: white;
            border-radius: 20px;
            padding: 35px;
            text-align: center;
            margin: 25px 0;
            box-shadow: 0 15px 50px rgba(26, 95, 122, 0.5);
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .speed-limit-display::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 60%);
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .speed-limit-display .speed-value {
            font-size: 5.5rem;
            font-weight: bold;
            line-height: 1;
            position: relative;
            z-index: 1;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
        }

        .speed-limit-display .speed-unit {
            font-size: 2.2rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .speed-limit-display .speed-label {
            font-size: 1.2rem;
            margin-top: 15px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .speed-limit-display.selected {
            animation: glow 2s infinite;
        }

        .risk-matrix {
            display: grid;
            grid-template-columns: auto repeat(3, 1fr);
            gap: 6px;
            margin: 25px 0;
        }

        .risk-matrix-cell {
            padding: 18px 12px;
            text-align: center;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.4s ease;
        }

        .risk-matrix-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .risk-matrix-label {
            background: linear-gradient(135deg, var(--secondary), #3d5c56);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .risk-20 {
            background: linear-gradient(135deg, #ff6b6b, #ef4444);
            color: white;
        }

        .risk-25 {
            background: linear-gradient(135deg, #fb923c, #f97316);
            color: white;
        }

        .risk-30 {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1f2937;
        }

        .risk-35 {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
        }

        .risk-matrix-cell.selected {
            border: 4px solid #1f2937;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
            transform: scale(1.15);
            z-index: 10;
            animation: pulse 1s infinite;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
        }

        .data-table th {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            font-weight: 600;
        }

        .data-table tr:nth-child(even) {
            background: var(--gray-50);
        }

        .data-table tr:hover {
            background: rgba(26, 95, 122, 0.1);
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 14px 24px;
            background: var(--gray-200);
            border: none;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .tab:hover {
            background: var(--gray-300);
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            transform: translateY(-3px);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        .alert {
            padding: 18px 22px;
            border-radius: 12px;
            margin-bottom: 22px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideInLeft 0.5s ease-out;
        }

        .alert-info {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .alert-success {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #166534;
            border-left: 4px solid #22c55e;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 18px;
            margin: 25px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            transition: all 0.4s ease;
            box-shadow: 0 10px 30px rgba(26, 95, 122, 0.3);
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 50px rgba(26, 95, 122, 0.4);
        }

        .stat-card .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .stat-card .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 8px;
        }

        .memo-preview {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 35px;
            font-family: 'Times New Roman', Georgia, serif;
            font-size: 12pt;
            line-height: 1.7;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .memo-preview::-webkit-scrollbar {
            width: 8px;
        }

        .memo-preview::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 4px;
        }

        .memo-preview::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .nacto-reference {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px;
            border-radius: 16px;
            margin-top: 25px;
            box-shadow: 0 10px 40px rgba(26, 95, 122, 0.3);
        }

        .nacto-reference h4 {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .nacto-reference ul {
            margin-left: 22px;
        }

        .nacto-reference li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        footer {
            text-align: center;
            color: white;
            padding: 30px;
            margin-top: 30px;
            animation: fadeIn 1s ease-out;
        }

        footer p {
            margin-bottom: 8px;
        }

        /* Print Styles */
        .print-only {
            display: none;
        }

        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            body {
                background: white !important;
                padding: 0 !important;
                font-size: 11pt;
            }

            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            .card {
                box-shadow: none !important;
                border: 1px solid #ddd;
                page-break-inside: avoid;
                margin-bottom: 20px;
            }

            .header {
                box-shadow: none !important;
                border-bottom: 3px solid var(--primary);
            }

            .page-break {
                page-break-before: always;
            }

            .print-section {
                page-break-inside: avoid;
                margin-bottom: 30px;
            }

            .btn,
            .tabs,
            .tab-content:not(.active) {
                display: none !important;
            }

            .risk-matrix-cell.selected {
                border: 3px solid #000 !important;
            }
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Print Report Container */
        #printReportContainer {
            display: none;
        }

        .appendix-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin: 30px 0 20px 0;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .legal-notice {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-size: 0.95rem;
        }

        .signature-block {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-300);
        }

        input[type="file"] {
            display: none;
        }

        /* VDOT Integration Styles */
        .vdot-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #1a5f7a;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
            vertical-align: middle;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .map-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a5f7a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <h1>üöó Speed Study Analysis Tool</h1>
            <p>NACTO City Limits Methodology for Safe Speed Limit Setting</p>
            <div class="badge-container">
                <span class="badge badge-primary">MUTCD 11th Edition Compliant</span>
                <span class="badge badge-accent">Safe System Approach</span>
            </div>
        </header>

        <!-- Embedded Interactive Map Section -->
        <div class="card" style="margin-bottom: 25px; padding: 0; overflow: hidden;">
            <div
                style="padding: 20px 30px; background: linear-gradient(135deg, #1a5f7a 0%, #134a5e 100%); color: white; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                    </svg>
                    <div>
                        <h2 style="margin: 0; font-size: 1.4rem;">Interactive Traffic Sign Map</h2>
                        <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Speed Limits & Stop/Yield Signs</p>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <label
                        style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" id="speedLayerToggle" checked
                            style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="display: flex; align-items: center; gap: 6px;"><span
                                style="width: 12px; height: 12px; background: linear-gradient(135deg, #22c55e, #ef4444); border-radius: 50%;"></span>Speed
                            Limits</span>
                    </label>
                    <label
                        style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" id="stopYieldLayerToggle" checked
                            style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="display: flex; align-items: center; gap: 6px;"><span
                                style="width: 12px; height: 12px; background: linear-gradient(135deg, #dc2626, #eab308); border-radius: 50%;"></span>Stop
                            & Yield</span>
                    </label>
                    <label
                        style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" id="vdotTrafficToggle"
                            style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="display: flex; align-items: center; gap: 6px;"><span
                                style="width: 12px; height: 12px; background: #3b82f6; border-radius: 50%;"></span>VDOT
                            Traffic</span>
                    </label>
                    <label
                        style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" id="vdotCrashToggle" style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="display: flex; align-items: center; gap: 6px;"><span
                                style="width: 12px; height: 12px; background: #ef4444; border-radius: 50%;"></span>VDOT
                            Crashes</span>
                    </label>
                    <label
                        style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" id="vdotSidewalkToggle"
                            style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="display: flex; align-items: center; gap: 6px;"><span
                                style="width: 12px; height: 12px; background: #fbbf24; border-radius: 50%;"></span>Sidewalks</span>
                    </label>
                    <label
                        style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" id="vdotSpeedToggle" style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="display: flex; align-items: center; gap: 6px;"><span
                                style="width: 12px; height: 12px; background: #10b981; border-radius: 50%;"></span>VDOT
                            Speeds</span>
                    </label>
                    <label
                        style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" id="vdotBikePedToggle"
                            style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="display: flex; align-items: center; gap: 6px;"><span
                                style="width: 12px; height: 12px; background: #8b5cf6; border-radius: 50%;"></span>Bike/Ped</span>
                    </label>
                    <label
                        style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" id="tigerwebToggle" style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="display: flex; align-items: center; gap: 6px;"><span
                                style="width: 12px; height: 12px; background: #1e3a8a; border-radius: 50%;"></span>Tigerweb</span>
                    </label>
                    <a href="map.html" target="_blank"
                        style="display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.95); color: #1a5f7a; padding: 8px 14px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 0.9rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                        Full Screen
                    </a>
                </div>
            </div>
            <!-- Map Tools Bar -->
            <div
                style="padding: 12px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <span style="font-weight: 600; color: #64748b; font-size: 0.85rem; margin-right: 10px;">Draw
                    Selection:</span>
                <button onclick="activatePolygonDraw()" id="polygonBtn" class="map-tool-btn"
                    style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500; color: #475569; transition: all 0.2s;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path
                            d="M5.525 3.025a.5.5 0 0 1 .707 0l.707.707 1.414-1.414-.707-.707a2.5 2.5 0 0 0-3.536 3.536l.707.707 1.414-1.414-.707-.707a.5.5 0 0 1 0-.707zm5.657 5.657a.5.5 0 0 1 0 .707l-.707.707 1.414 1.414.707-.707a2.5 2.5 0 0 0-3.536-3.536l-.707.707 1.414 1.414.707-.707a.5.5 0 0 1 .707 0z" />
                        <path d="m1.5 14.5 1-5 5 1-1 4zm4-10 5 1-4 4-1-5z" />
                    </svg>
                    Polygon
                </button>
                <button onclick="activateCircleDraw()" id="circleBtn" class="map-tool-btn"
                    style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500; color: #475569; transition: all 0.2s;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        viewBox="0 0 16 16">
                        <circle cx="8" cy="8" r="6" fill="none" stroke="currentColor" stroke-width="2" />
                    </svg>
                    Circle
                </button>
                <button onclick="activateRectangleDraw()" id="rectangleBtn" class="map-tool-btn"
                    style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500; color: #475569; transition: all 0.2s;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor"
                        stroke-width="2" viewBox="0 0 16 16">
                        <rect x="2" y="3" width="12" height="10" rx="1" />
                    </svg>
                    Rectangle
                </button>
                <button onclick="clearAllSelections()" class="map-tool-btn"
                    style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500; color: #ef4444; transition: all 0.2s;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor"
                        stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Clear
                </button>

                <div style="margin-left: 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-weight: 600; color: #64748b; font-size: 0.85rem;">Base Map:</span>
                    <select id="baseMapSelector" onchange="changeBaseMap(this.value)"
                        style="padding: 6px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.85rem; color: #475569; background: white; cursor: pointer; outline: none;">
                        <option value="osm">OpenStreetMap</option>
                        <option value="esri">Esri Basemap</option>
                    </select>
                </div>

                <div style="margin-left: 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-weight: 600; color: #64748b; font-size: 0.85rem;">County:</span>
                    <select id="countySelector" onchange="zoomToCounty(this.value)"
                        style="padding: 6px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.85rem; color: #475569; background: white; cursor: pointer; outline: none; min-width: 150px;">
                        <option value="">Whole Virginia</option>
                    </select>
                </div>

                <div style="margin-left: auto; display: flex; align-items: center; gap: 15px;">
                    <span id="mapSignCount" style="font-size: 0.85rem; color: #64748b;">Loading signs...</span>
                    <div id="selectionInfo"
                        style="display: none; background: #1a5f7a; color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 500;">
                    </div>
                </div>
            </div>
            <!-- Map Container -->
            <div style="position: relative;">
                <div id="embeddedMap" style="height: 500px; width: 100%;"></div>
                <div id="crashScaleWarning"
                    style="display: none; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(239, 68, 68, 0.95); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2); pointer-events: none;">
                    ‚ö†Ô∏è Zoom in closer to see VDOT Crash data
                </div>
                <div id="mapLoadingOverlay" class="map-loading-overlay">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px; color: #1a5f7a; font-weight: 600; font-size: 0.9rem;">Fetching VDOT
                        Data...</p>
                </div>
            </div>
            <!-- Legend with MUTCD Signs -->
            <div
                style="padding: 15px 20px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; gap: 24px; flex-wrap: wrap; justify-content: center; align-items: center;">
                <span
                    style="font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Speed
                    Limits (R2-1):</span>
                <div style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #475569;">
                    <div
                        style="width: 22px; height: 28px; background: white; border: 1.5px solid black; border-radius: 2px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="font-size: 3px; font-weight: bold;">SPEED</div>
                        <div style="font-size: 3px; font-weight: bold;">LIMIT</div>
                        <div style="font-size: 11px; font-weight: bold;">25</div>
                    </div>
                    <span>25 MPH</span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #475569;">
                    <div
                        style="width: 22px; height: 28px; background: white; border: 1.5px solid black; border-radius: 2px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="font-size: 3px; font-weight: bold;">SPEED</div>
                        <div style="font-size: 3px; font-weight: bold;">LIMIT</div>
                        <div style="font-size: 11px; font-weight: bold;">35</div>
                    </div>
                    <span>35 MPH</span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #475569;">
                    <div
                        style="width: 22px; height: 28px; background: white; border: 1.5px solid black; border-radius: 2px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="font-size: 3px; font-weight: bold;">SPEED</div>
                        <div style="font-size: 3px; font-weight: bold;">LIMIT</div>
                        <div style="font-size: 11px; font-weight: bold;">45</div>
                    </div>
                    <span>45 MPH</span>
                </div>
                <div style="width: 1px; height: 30px; background: #cbd5e1;"></div>
                <span
                    style="font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Regulatory:</span>
                <div style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #475569;">
                    <div
                        style="width: 24px; height: 24px; background: #cc0000; clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%); display: flex; align-items: center; justify-content: center;">
                        <span style="color: white; font-size: 5px; font-weight: bold;">STOP</span>
                    </div>
                    <span>STOP (R1-1)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #475569;">
                    <div style="width: 26px; height: 22px; position: relative;">
                        <div
                            style="width: 0; height: 0; border-left: 13px solid transparent; border-right: 13px solid transparent; border-top: 22px solid #cc0000; position: absolute;">
                        </div>
                        <div
                            style="width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 17px solid white; position: absolute; top: 2px; left: 3px;">
                        </div>
                        <div
                            style="position: absolute; top: 5px; left: 50%; transform: translateX(-50%); color: #cc0000; font-size: 4px; font-weight: bold;">
                            YIELD</div>
                    </div>
                    <span>YIELD (R1-2)</span>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Left Column - Input Section -->
            <div>
                <!-- Project Information -->
                <div class="card">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Project Information
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="roadwayName"
                                style="display: flex; justify-content: space-between; align-items: center;">
                                Roadway Name *
                                <button type="button" onclick="fetchVDOTDataManual()" class="btn-vdot-fetch"
                                    title="Fetch data from VDOT ArcGIS">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2.5">
                                        <path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        <path d="M9 12l2 2 4-4" />
                                    </svg>
                                    Fetch VDOT
                                </button>
                            </label>
                            <input type="text" id="roadwayName" placeholder="Enter roadway name">
                        </div>
                        <div class="form-group">
                            <label for="studyDate">Study Date *</label>
                            <input type="date" id="studyDate">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="fromLocation">From Location</label>
                            <input type="text" id="fromLocation" placeholder="Starting point">
                        </div>
                        <div class="form-group">
                            <label for="toLocation">To Location</label>
                            <input type="text" id="toLocation" placeholder="Ending point">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="corridorLength">Corridor Length (miles)</label>
                            <input type="number" id="corridorLength" step="0.1" placeholder="0.0">
                        </div>
                        <div class="form-group">
                            <label for="currentSpeedLimit">Current Posted Speed Limit (mph)</label>
                            <input type="number" id="currentSpeedLimit" placeholder="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="roadwayClass">Roadway Functional Classification</label>
                            <select id="roadwayClass">
                                <option value="">Select Classification</option>
                                <option value="local">Local Street</option>
                                <option value="collector-minor">Minor Collector</option>
                                <option value="collector-major">Major Collector</option>
                                <option value="arterial-minor">Minor Arterial</option>
                                <option value="arterial-major">Major Arterial</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="jurisdiction">Jurisdiction</label>
                            <input type="text" id="jurisdiction" placeholder="County/City name">
                        </div>
                    </div>

                    <div class="vdot-legend">
                        <span class="vdot-badge"><svg width="10" height="10" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="3">
                                <path d="M20 6L9 17l-5-5" />
                            </svg> VDOT</span>
                        <span style="font-size: 0.75rem; color: #64748b;">Auto-populated from Virginia Dept of
                            Transportation database</span>
                    </div>
                </div>

                <!-- Speed Data Input -->
                <div class="card" style="margin-top: 25px;">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Speed Data
                    </h2>

                    <div class="alert alert-info">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Enter speed data collected from your traffic study equipment.</span>
                    </div>

                    <div class="form-row-3">
                        <div class="form-group">
                            <label for="meanSpeed">Mean Speed (mph) *</label>
                            <input type="number" id="meanSpeed" step="0.1" placeholder="0.0">
                        </div>
                        <div class="form-group">
                            <label for="medianSpeed">Median Speed (mph)</label>
                            <input type="number" id="medianSpeed" step="0.1" placeholder="0.0">
                        </div>
                        <div class="form-group">
                            <label for="p85Speed">85th Percentile Speed (mph) *</label>
                            <input type="number" id="p85Speed" step="0.1" placeholder="0.0">
                        </div>
                    </div>

                    <div class="form-row-3">
                        <div class="form-group">
                            <label for="minSpeed">Minimum Speed (mph)</label>
                            <input type="number" id="minSpeed" step="0.1" placeholder="0.0">
                        </div>
                        <div class="form-group">
                            <label for="maxSpeed">Maximum Speed (mph)</label>
                            <input type="number" id="maxSpeed" step="0.1" placeholder="0.0">
                        </div>
                        <div class="form-group">
                            <label for="stdDev">Standard Deviation (mph)</label>
                            <input type="number" id="stdDev" step="0.1" placeholder="0.0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="totalVehicles">Total Vehicles Surveyed</label>
                            <input type="number" id="totalVehicles" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="avgDailyTraffic">Average Daily Traffic (ADT)</label>
                            <input type="number" id="avgDailyTraffic" placeholder="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="exceedingPosted">% Exceeding Posted Speed Limit</label>
                            <input type="number" id="exceedingPosted" step="0.1" placeholder="0.0">
                        </div>
                        <div class="form-group">
                            <label for="paceSpeed">10 mph Pace Range (mph)</label>
                            <input type="text" id="paceSpeed" placeholder="e.g., 32-42">
                        </div>
                    </div>
                </div>

                <!-- Traffic Volume Data -->
                <div class="card" style="margin-top: 25px;">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        Additional Data
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pedestrianVolume">Pedestrian Volume (per day)</label>
                            <input type="number" id="pedestrianVolume" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="bicycleVolume">Bicycle Volume (per day)</label>
                            <input type="number" id="bicycleVolume" placeholder="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="crashCount">Total Crashes (last 3-5 years)</label>
                            <input type="number" id="crashCount" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="signalCount">Number of Traffic Signals</label>
                            <input type="number" id="signalCount" placeholder="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="crashNarrative">Crash Pattern Notes</label>
                        <textarea id="crashNarrative" rows="3"
                            placeholder="Describe any crash patterns observed..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Right Column - Analysis Section -->
            <div>
                <!-- NACTO Conflict Density Analysis -->
                <div class="card">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        NACTO Conflict Density Analysis
                    </h2>

                    <div class="alert alert-warning">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <span><strong>NACTO City Limits:</strong> Conflict density considers modal mixing and crossing
                            point density to determine risk levels.</span>
                    </div>

                    <div class="checklist-section">
                        <h4>üö∂ Modal Mixing - Pedestrian Facilities</h4>
                        <div class="checklist-item" onclick="toggleCheckbox('noSidewalks')">
                            <input type="checkbox" id="noSidewalks">
                            <label for="noSidewalks">No sidewalks present</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('sidewalksOneSide')">
                            <input type="checkbox" id="sidewalksOneSide">
                            <label for="sidewalksOneSide">Sidewalk present on only one side of roadway</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('sidewalksAdjacent')">
                            <input type="checkbox" id="sidewalksAdjacent">
                            <label for="sidewalksAdjacent">Sidewalks directly adjacent to moving traffic (no
                                buffer)</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('sidewalksBuffered')">
                            <input type="checkbox" id="sidewalksBuffered">
                            <label for="sidewalksBuffered">USDG-compliant sidewalk with buffer, parking, or loading
                                lane</label>
                        </div>
                    </div>

                    <div class="checklist-section">
                        <h4>üö¥ Modal Mixing - Bicycle Facilities</h4>
                        <div class="checklist-item" onclick="toggleCheckbox('noBikeFacilities')">
                            <input type="checkbox" id="noBikeFacilities">
                            <label for="noBikeFacilities">No bicycle facilities present (mixed traffic)</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('sharrows')">
                            <input type="checkbox" id="sharrows">
                            <label for="sharrows">Sharrows or shared lane markings only</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('markedBikeLane')">
                            <input type="checkbox" id="markedBikeLane">
                            <label for="markedBikeLane">Marked bike lane (unprotected)</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('bufferedBikeLane')">
                            <input type="checkbox" id="bufferedBikeLane">
                            <label for="bufferedBikeLane">Buffered bike lane or planned bike lane</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('protectedBikeLane')">
                            <input type="checkbox" id="protectedBikeLane">
                            <label for="protectedBikeLane">Protected bike lane, shared use path, or cycle track</label>
                        </div>
                    </div>

                    <div class="checklist-section">
                        <h4>üîÄ Crossing Point Density</h4>
                        <div class="checklist-item" onclick="toggleCheckbox('highCrossingDensity')">
                            <input type="checkbox" id="highCrossingDensity">
                            <label for="highCrossingDensity">‚â•3 through/T intersections, major driveways, or crossing
                                points per ¬º mile</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('moderateCrossingDensity')">
                            <input type="checkbox" id="moderateCrossingDensity">
                            <label for="moderateCrossingDensity">1-3 through/T intersections or crossing points per ¬º
                                mile</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('lowCrossingDensity')">
                            <input type="checkbox" id="lowCrossingDensity">
                            <label for="lowCrossingDensity">No through/T intersections and few driveways per ¬º
                                mile</label>
                        </div>
                    </div>

                    <div id="conflictDensityResult" class="result-box result-moderate">
                        <h3>MODERATE CONFLICT DENSITY</h3>
                        <p>Complete the checklist above to see your result</p>
                    </div>
                </div>

                <!-- NACTO Activity Level Analysis -->
                <div class="card" style="margin-top: 25px;">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        NACTO Activity Level Analysis
                    </h2>

                    <div class="checklist-section">
                        <h4>üè¢ Land Use Context (High Activity)</h4>
                        <div class="checklist-item" onclick="toggleCheckbox('downtown')">
                            <input type="checkbox" id="downtown">
                            <label for="downtown">Downtown / Central Business District</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('retailCorridor')">
                            <input type="checkbox" id="retailCorridor">
                            <label for="retailCorridor">Retail corridor with active storefronts</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('highDensity')">
                            <input type="checkbox" id="highDensity">
                            <label for="highDensity">High density residential or commercial</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('schoolZone')">
                            <input type="checkbox" id="schoolZone">
                            <label for="schoolZone">School zone present</label>
                        </div>
                    </div>

                    <div class="checklist-section">
                        <h4>üè† Land Use Context (Moderate Activity)</h4>
                        <div class="checklist-item" onclick="toggleCheckbox('moderateResidential')">
                            <input type="checkbox" id="moderateResidential">
                            <label for="moderateResidential">Moderate density residential or commercial</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('lightRetail')">
                            <input type="checkbox" id="lightRetail">
                            <label for="lightRetail">Street with light retail activity</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('mixedUse')">
                            <input type="checkbox" id="mixedUse">
                            <label for="mixedUse">Mixed use corridor</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('hotelConference')">
                            <input type="checkbox" id="hotelConference">
                            <label for="hotelConference">Hotel/conference center present</label>
                        </div>
                    </div>

                    <div class="checklist-section">
                        <h4>üè≠ Land Use Context (Low Activity)</h4>
                        <div class="checklist-item" onclick="toggleCheckbox('lowDensityIndustrial')">
                            <input type="checkbox" id="lowDensityIndustrial">
                            <label for="lowDensityIndustrial">Low density industrial area</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('lowDensityResidential')">
                            <input type="checkbox" id="lowDensityResidential">
                            <label for="lowDensityResidential">Low density residential (rural/suburban)</label>
                        </div>
                        <div class="checklist-item" onclick="toggleCheckbox('privateGated')">
                            <input type="checkbox" id="privateGated">
                            <label for="privateGated">Serves primarily private gated community</label>
                        </div>
                    </div>

                    <div id="activityLevelResult" class="result-box result-moderate">
                        <h3>MODERATE ACTIVITY</h3>
                        <p>Complete the checklist above to see your result</p>
                    </div>
                </div>
            </div>

            <!-- Full Width - Results Section -->
            <div class="card full-width">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    NACTO Risk Matrix & Recommended Speed Limit
                </h2>

                <div class="risk-matrix">
                    <div class="risk-matrix-cell"></div>
                    <div class="risk-matrix-cell risk-matrix-header">HIGH CONFLICT</div>
                    <div class="risk-matrix-cell risk-matrix-header">MODERATE CONFLICT</div>
                    <div class="risk-matrix-cell risk-matrix-header">LOW CONFLICT</div>

                    <div class="risk-matrix-cell risk-matrix-label">HIGH ACTIVITY</div>
                    <div class="risk-matrix-cell risk-20" id="cell-high-high">20 MPH</div>
                    <div class="risk-matrix-cell risk-20" id="cell-high-moderate">20 MPH</div>
                    <div class="risk-matrix-cell risk-25" id="cell-high-low">25 MPH</div>

                    <div class="risk-matrix-cell risk-matrix-label">MODERATE ACTIVITY</div>
                    <div class="risk-matrix-cell risk-20" id="cell-moderate-high">20 MPH</div>
                    <div class="risk-matrix-cell risk-25" id="cell-moderate-moderate">25 MPH</div>
                    <div class="risk-matrix-cell risk-30" id="cell-moderate-low">30 MPH</div>

                    <div class="risk-matrix-cell risk-matrix-label">LOW ACTIVITY</div>
                    <div class="risk-matrix-cell risk-25" id="cell-low-high">25 MPH</div>
                    <div class="risk-matrix-cell risk-25" id="cell-low-moderate">25 MPH</div>
                    <div class="risk-matrix-cell risk-35" id="cell-low-low">35 MPH</div>
                </div>

                <div class="form-row">
                    <div class="speed-limit-display" id="nactoSpeedDisplay">
                        <div class="speed-label">NACTO RECOMMENDED SPEED LIMIT</div>
                        <div class="speed-value" id="recommendedSpeed">--</div>
                        <div class="speed-unit">MPH</div>
                    </div>
                    <div class="speed-limit-display" style="background: linear-gradient(135deg, #57837b, #3d5c56);">
                        <div class="speed-label">85TH PERCENTILE METHOD</div>
                        <div class="speed-value" id="p85RecommendedSpeed">--</div>
                        <div class="speed-unit">MPH</div>
                    </div>
                </div>

                <div class="alert alert-success" id="recommendationSummary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span><strong>Analysis Summary:</strong> Complete all required fields and checklists to generate the
                        speed limit recommendation.</span>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="calculateRecommendation()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        Calculate Recommendation
                    </button>
                    <button class="btn btn-danger" onclick="clearAll()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Clear All
                    </button>
                </div>
            </div>

            <!-- Memo Information -->
            <div class="card full-width">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" />
                    </svg>
                    Memo Details
                </h2>

                <div class="form-row">
                    <div class="form-group">
                        <label for="memoTo">TO:</label>
                        <input type="text" id="memoTo" placeholder="Recipient name/title">
                    </div>
                    <div class="form-group">
                        <label for="memoFrom">FROM:</label>
                        <input type="text" id="memoFrom" placeholder="Department/Division">
                    </div>
                </div>

                <div class="form-group">
                    <label for="memoSubject">SUBJECT:</label>
                    <input type="text" id="memoSubject" placeholder="Speed Study Evaluation - [Roadway Name]">
                </div>

                <div class="form-group">
                    <label for="additionalNotes">Additional Notes/Recommendations</label>
                    <textarea id="additionalNotes" rows="4"
                        placeholder="Add any additional context, justification, or recommendations..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="signatureName">Prepared By (Name & Title)</label>
                        <input type="text" id="signatureName" placeholder="Name, Title">
                    </div>
                    <div class="form-group">
                        <label for="ccList">CC: (Distribution List)</label>
                        <input type="text" id="ccList" placeholder="Distribution list">
                    </div>
                </div>
            </div>

            <!-- Report Generation -->
            <div class="card full-width no-print">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Generate Reports
                </h2>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab('preview')">üìÑ Preview</button>
                    <button class="tab" onclick="switchTab('calculations')">üî¢ Calculations</button>
                    <button class="tab" onclick="switchTab('nacto')">üìã NACTO Summary</button>
                </div>

                <div id="preview-tab" class="tab-content active">
                    <div class="memo-preview" id="memoPreview">
                        <h2 style="text-align: center; font-weight: bold; margin-bottom: 5px;">INTER-OFFICE MEMORANDUM
                        </h2>
                        <hr style="margin-bottom: 20px;">
                        <table
                            style="width: 100%; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 15px;">
                            <tr>
                                <td style="width: 80px; padding: 5px 0;"><strong>TO:</strong></td>
                                <td id="previewTo">--</td>
                            </tr>
                            <tr>
                                <td style="padding: 5px 0;"><strong>FROM:</strong></td>
                                <td id="previewFrom">--</td>
                            </tr>
                            <tr>
                                <td style="padding: 5px 0;"><strong>SUBJECT:</strong></td>
                                <td id="previewSubject">Speed Study Evaluation</td>
                            </tr>
                            <tr>
                                <td style="padding: 5px 0;"><strong>DATE:</strong></td>
                                <td id="previewDate"></td>
                            </tr>
                        </table>
                        <div id="previewBody">
                            <p>Complete the form and click "Calculate Recommendation" to generate the memo preview.</p>
                        </div>
                    </div>
                </div>

                <div id="calculations-tab" class="tab-content">
                    <div class="stat-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="calcMeanSpeed">--</div>
                            <div class="stat-label">Mean Speed (mph)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="calcP85Speed">--</div>
                            <div class="stat-label">85th Percentile (mph)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="calcP85Rounded">--</div>
                            <div class="stat-label">85th % Method Result</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="calcNACTOResult">--</div>
                            <div class="stat-label">NACTO Result (mph)</div>
                        </div>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Value</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="calculationsTable">
                            <tr>
                                <td colspan="3">Run analysis to see calculations</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="nacto-tab" class="tab-content">
                    <div class="nacto-reference">
                        <h4>üìö NACTO City Limits Reference</h4>
                        <p style="margin-bottom: 15px;">Based on the 11th Edition MUTCD and NACTO's Safe Speed Study
                            methodology:</p>
                        <ul>
                            <li><strong>Conflict Density:</strong> Determined by modal mixing (pedestrian/bicycle
                                facilities) and crossing point density</li>
                            <li><strong>Activity Level:</strong> Based on land use context and expected/existing
                                pedestrian and bicycle activity</li>
                            <li><strong>Risk Matrix:</strong> Combines conflict density and activity level to determine
                                the safest speed limit</li>
                        </ul>
                    </div>

                    <div id="nactoSummary" style="margin-top: 25px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;">Analysis Summary</h4>
                        <div id="nactoSummaryContent">
                            <p>Complete the analysis checklists to see the NACTO methodology summary.</p>
                        </div>
                    </div>
                </div>

                <div class="btn-group" style="margin-top: 25px;">
                    <button class="btn btn-primary" onclick="generateWordDoc()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Download Word Memo (.doc)
                    </button>
                    <button class="btn btn-success" onclick="printFullReport()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                        </svg>
                        Print Full Report
                    </button>
                    <button class="btn btn-secondary" onclick="saveProject()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                        Save Project
                    </button>
                    <button class="btn btn-info" onclick="loadProject()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        Load Project
                    </button>
                </div>
            </div>
        </div>

        <footer>
            <p>Speed Study Analysis Tool | Based on NACTO City Limits (2020) & MUTCD 11th Edition (2023)</p>
            <p style="font-size: 0.9rem; opacity: 0.8;">For engineering study purposes only. Professional judgment
                should be applied.</p>
        </footer>
    </div>

    <!-- Print Report Container (Hidden) -->
    <div id="printReportContainer">
        <!-- This will be populated when printing -->
    </div>

    <input type="file" id="fileInput" accept=".json">

    <script>
        // Global state
        let analysisState = {
            conflictDensity: 'moderate',
            activityLevel: 'moderate',
            recommendedSpeed: null,
            p85RecommendedSpeed: null
        };

        // Tigerweb Configuration
        const TIGERWEB_CONFIG = {
            enabled: true,
            baseUrl: "https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/tigerWMS_Census2020/MapServer",
            countySubdivisionsUrl: "https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/Places_CouSub_ConCity_SubMCD/MapServer",
            stateFips: "51",
            layers: {
                counties: 82,
                tracts: 14,
                blockGroups: 16,
                countySubdivisions: 1
            },
            boundaryStyle: {
                color: "#1e3a8a",
                weight: 3,
                fillColor: "#1e3a8a",
                fillOpacity: 0.05,
                dashArray: "8, 4"
            }
        };

        // Jurisdictions Data (Counties and Cities in Virginia)
        const JURISDICTIONS = {
            "accomack": { name: "Accomack County", fips: "001", mapCenter: [37.76, -75.66], bbox: [-76.0533, 37.2918, -75.2429, 38.0274] },
            "albemarle": { name: "Albemarle County", fips: "003", mapCenter: [38.02, -78.56], bbox: [-78.8399, 37.7273, -78.2637, 38.3034] },
            "alleghany": { name: "Alleghany County", fips: "005", mapCenter: [37.79, -79.95], bbox: [-80.2213, 37.5672, -79.6473, 38.0134] },
            "amelia": { name: "Amelia County", fips: "007", mapCenter: [37.34, -77.98], bbox: [-78.1777, 37.1458, -77.6553, 37.4678] },
            "amherst": { name: "Amherst County", fips: "009", mapCenter: [37.6, -79.14], bbox: [-79.4745, 37.3962, -78.8591, 37.806] },
            "appomattox": { name: "Appomattox County", fips: "011", mapCenter: [37.37, -78.81], bbox: [-79.0929, 37.2061, -78.5716, 37.5494] },
            "arlington": { name: "Arlington County", fips: "013", mapCenter: [38.88, -77.1], bbox: [-77.1722, 38.8275, -77.032, 38.9341] },
            "augusta": { name: "Augusta County", fips: "015", mapCenter: [38.16, -79.13], bbox: [-79.5431, 37.8873, -78.8617, 38.4767] },
            "bath": { name: "Bath County", fips: "017", mapCenter: [38.07, -79.73], bbox: [-80.0564, 37.8573, -79.4479, 38.3947] },
            "bedford_county": { name: "Bedford County", fips: "019", mapCenter: [37.31, -79.52], bbox: [-79.7888, 37.0341, -79.2507, 37.513] },
            "bland": { name: "Bland County", fips: "021", mapCenter: [37.1, -81.12], bbox: [-81.3447, 36.9649, -80.8546, 37.2462] },
            "botetourt": { name: "Botetourt County", fips: "023", mapCenter: [37.55, -79.81], bbox: [-80.0746, 37.2621, -79.5384, 37.7892] },
            "brunswick": { name: "Brunswick County", fips: "025", mapCenter: [36.76, -77.85], bbox: [-78.0045, 36.5437, -77.3991, 36.9601] },
            "buchanan": { name: "Buchanan County", fips: "027", mapCenter: [37.27, -82.03], bbox: [-82.3145, 37.0199, -81.7292, 37.5137] },
            "buckingham": { name: "Buckingham County", fips: "029", mapCenter: [37.55, -78.55], bbox: [-78.8693, 37.3051, -78.2554, 37.7318] },
            "campbell": { name: "Campbell County", fips: "031", mapCenter: [37.2, -79.09], bbox: [-79.4361, 36.9684, -78.9035, 37.4249] },
            "caroline": { name: "Caroline County", fips: "033", mapCenter: [38.03, -77.35], bbox: [-77.6421, 37.7538, -76.9722, 38.241] },
            "carroll": { name: "Carroll County", fips: "035", mapCenter: [36.73, -80.73], bbox: [-80.9618, 36.5454, -80.4409, 36.9417] },
            "charles_city": { name: "Charles City County", fips: "036", mapCenter: [37.36, -77.06], bbox: [-77.3504, 37.2247, -76.8551, 37.4756] },
            "charlotte": { name: "Charlotte County", fips: "037", mapCenter: [37.01, -78.66], bbox: [-79.0418, 36.8483, -78.4394, 37.241] },
            "chesterfield": { name: "Chesterfield County", fips: "041", mapCenter: [37.38, -77.5], bbox: [-77.808, 37.1524, -77.3744, 37.5559] },
            "clarke": { name: "Clarke County", fips: "043", mapCenter: [39.11, -77.99], bbox: [-78.1355, 39.0059, -77.8276, 39.2321] },
            "craig": { name: "Craig County", fips: "045", mapCenter: [37.47, -80.23], bbox: [-80.4591, 37.2311, -79.9754, 37.5958] },
            "culpeper": { name: "Culpeper County", fips: "047", mapCenter: [38.49, -77.96], bbox: [-78.1631, 38.2803, -77.6158, 38.7127] },
            "cumberland": { name: "Cumberland County", fips: "049", mapCenter: [37.51, -78.24], bbox: [-78.4641, 37.2972, -78.0659, 37.6791] },
            "dickenson": { name: "Dickenson County", fips: "051", mapCenter: [37.12, -82.35], bbox: [-82.5638, 36.963, -82.0936, 37.3028] },
            "dinwiddie": { name: "Dinwiddie County", fips: "053", mapCenter: [37.08, -77.58], bbox: [-77.8651, 36.8633, -77.3139, 37.2789] },
            "essex": { name: "Essex County", fips: "057", mapCenter: [37.94, -76.94], bbox: [-77.1551, 37.7641, -76.708, 38.0844] },
            "fairfax_county": { name: "Fairfax County", fips: "059", mapCenter: [38.83, -77.28], bbox: [-77.5351, 38.5943, -77.0492, 39.0003] },
            "fauquier": { name: "Fauquier County", fips: "061", mapCenter: [38.72, -77.81], bbox: [-78.0057, 38.4541, -77.5286, 38.9303] },
            "floyd": { name: "Floyd County", fips: "063", mapCenter: [36.93, -80.36], bbox: [-80.5399, 36.7413, -80.1345, 37.1089] },
            "fluvanna": { name: "Fluvanna County", fips: "065", mapCenter: [37.84, -78.28], bbox: [-78.5399, 37.6873, -78.0237, 37.9934] },
            "franklin_county": { name: "Franklin County", fips: "067", mapCenter: [36.99, -79.88], bbox: [-80.1945, 36.7841, -79.5637, 37.1934] },
            "frederick": { name: "Frederick County", fips: "069", mapCenter: [39.2, -78.26], bbox: [-78.4745, 39.0273, -78.0437, 39.3734] },
            "giles": { name: "Giles County", fips: "071", mapCenter: [37.32, -80.7], bbox: [-80.9245, 37.1573, -80.4737, 37.4834] },
            "gloucester": { name: "Gloucester County", fips: "073", mapCenter: [37.4, -76.52], bbox: [-76.7245, 37.2373, -76.3137, 37.5634] },
            "goochland": { name: "Goochland County", fips: "075", mapCenter: [37.72, -77.92], bbox: [-78.1245, 37.5573, -77.7137, 37.8834] },
            "grayson": { name: "Grayson County", fips: "077", mapCenter: [36.65, -81.22], bbox: [-81.4245, 36.4873, -81.0137, 36.8134] },
            "greene": { name: "Greene County", fips: "079", mapCenter: [38.3, -78.47], bbox: [-78.6745, 38.1373, -78.2637, 38.4634] },
            "greensville": { name: "Greensville County", fips: "081", mapCenter: [36.68, -77.56], bbox: [-77.7645, 36.5173, -77.3537, 36.8434] },
            "halifax": { name: "Halifax County", fips: "083", mapCenter: [36.77, -78.93], bbox: [-79.1345, 36.6073, -78.7237, 36.9334] },
            "hanover": { name: "Hanover County", fips: "085", mapCenter: [37.76, -77.49], bbox: [-77.6945, 37.5973, -77.2837, 37.9234] },
            "henrico": { name: "Henrico County", fips: "087", mapCenter: [37.55, -77.39], bbox: [-77.5945, 37.3873, -77.1837, 37.7134] },
            "henry": { name: "Henry County", fips: "089", mapCenter: [36.68, -79.92], bbox: [-80.1245, 36.5173, -79.7137, 36.8434] },
            "highland": { name: "Highland County", fips: "091", mapCenter: [38.35, -79.56], bbox: [-79.7645, 38.1873, -79.3537, 38.5134] },
            "isle_of_wight": { name: "Isle of Wight County", fips: "093", mapCenter: [36.91, -76.71], bbox: [-76.9145, 36.7473, -76.5037, 37.0734] },
            "james_city": { name: "James City County", fips: "095", mapCenter: [37.31, -76.81], bbox: [-77.0145, 37.1473, -76.6037, 37.4734] },
            "king_and_queen": { name: "King and Queen County", fips: "097", mapCenter: [37.72, -76.9], bbox: [-77.1045, 37.5573, -76.6937, 37.8834] },
            "king_george": { name: "King George County", fips: "099", mapCenter: [38.27, -77.15], bbox: [-77.3545, 38.1073, -76.9437, 38.4334] },
            "king_william": { name: "King William County", fips: "101", mapCenter: [37.7, -77.1], bbox: [-77.3045, 37.5373, -76.8937, 37.8634] },
            "lancaster": { name: "Lancaster County", fips: "103", mapCenter: [37.71, -76.41], bbox: [-76.6145, 37.5473, -76.2037, 37.8734] },
            "lee": { name: "Lee County", fips: "105", mapCenter: [36.71, -83.12], bbox: [-83.3245, 36.5473, -82.9137, 36.8734] },
            "loudoun": { name: "Loudoun County", fips: "107", mapCenter: [39.09, -77.64], bbox: [-77.8445, 38.9273, -77.4337, 39.2534] },
            "louisa": { name: "Louisa County", fips: "109", mapCenter: [38.03, -77.96], bbox: [-78.1645, 37.8673, -77.7537, 38.1934] },
            "lunenburg": { name: "Lunenburg County", fips: "111", mapCenter: [36.95, -78.24], bbox: [-78.4445, 36.7873, -78.0337, 37.1134] },
            "madison": { name: "Madison County", fips: "113", mapCenter: [38.41, -78.28], bbox: [-78.4845, 38.2473, -78.0737, 38.5734] },
            "mathews": { name: "Mathews County", fips: "115", mapCenter: [37.42, -76.35], bbox: [-76.5545, 37.2573, -76.1437, 37.5834] },
            "mecklenburg": { name: "Mecklenburg County", fips: "117", mapCenter: [36.68, -78.37], bbox: [-78.5745, 36.5173, -78.1637, 36.8434] },
            "middlesex": { name: "Middlesex County", fips: "119", mapCenter: [37.61, -76.51], bbox: [-76.7145, 37.4473, -76.3037, 37.7734] },
            "montgomery": { name: "Montgomery County", fips: "121", mapCenter: [37.17, -80.38], bbox: [-80.5845, 37.0073, -80.1737, 37.3334] },
            "nelson": { name: "Nelson County", fips: "125", mapCenter: [37.79, -78.89], bbox: [-79.0945, 37.6273, -78.6837, 37.9534] },
            "new_kent": { name: "New Kent County", fips: "127", mapCenter: [37.51, -76.99], bbox: [-77.1945, 37.3473, -76.7837, 37.6734] },
            "northampton": { name: "Northampton County", fips: "131", mapCenter: [37.3, -75.92], bbox: [-76.1245, 37.1373, -75.7137, 37.4634] },
            "northumberland": { name: "Northumberland County", fips: "133", mapCenter: [37.89, -76.38], bbox: [-76.5845, 37.7273, -76.1737, 38.0534] },
            "nottoway": { name: "Nottoway County", fips: "135", mapCenter: [37.14, -78.05], bbox: [-78.2545, 36.9773, -77.8437, 37.3034] },
            "orange": { name: "Orange County", fips: "137", mapCenter: [38.25, -78.01], bbox: [-78.2145, 38.0873, -77.8037, 38.4134] },
            "page": { name: "Page County", fips: "139", mapCenter: [38.62, -78.48], bbox: [-78.6845, 38.4573, -78.2737, 38.7834] },
            "patrick": { name: "Patrick County", fips: "141", mapCenter: [36.68, -80.28], bbox: [-80.4845, 36.5173, -80.0737, 36.8434] },
            "pittsylvania": { name: "Pittsylvania County", fips: "143", mapCenter: [36.82, -79.3], bbox: [-79.5045, 36.6573, -79.0937, 36.9834] },
            "powhatan": { name: "Powhatan County", fips: "145", mapCenter: [37.54, -77.92], bbox: [-78.1245, 37.3773, -77.7137, 37.7034] },
            "prince_edward": { name: "Prince Edward County", fips: "147", mapCenter: [37.22, -78.44], bbox: [-78.6445, 37.0573, -78.2337, 37.3834] },
            "prince_george": { name: "Prince George County", fips: "149", mapCenter: [37.19, -77.22], bbox: [-77.4245, 37.0273, -77.0137, 37.3534] },
            "prince_william": { name: "Prince William County", fips: "153", mapCenter: [38.71, -77.48], bbox: [-77.6845, 38.5473, -77.2737, 38.8734] },
            "pulaski": { name: "Pulaski County", fips: "155", mapCenter: [37.06, -80.71], bbox: [-80.9145, 36.8973, -80.5037, 37.2234] },
            "rappahannock": { name: "Rappahannock County", fips: "157", mapCenter: [38.68, -78.17], bbox: [-78.3745, 38.5173, -77.9637, 38.8434] },
            "richmond_county": { name: "Richmond County", fips: "159", mapCenter: [37.94, -76.73], bbox: [-76.9345, 37.7773, -76.5237, 38.1034] },
            "roanoke_county": { name: "Roanoke County", fips: "161", mapCenter: [37.27, -80.06], bbox: [-80.2645, 37.1073, -79.8537, 37.4334] },
            "rockbridge": { name: "Rockbridge County", fips: "163", mapCenter: [37.81, -79.45], bbox: [-79.6545, 37.6473, -79.2437, 37.9734] },
            "rockingham": { name: "Rockingham County", fips: "165", mapCenter: [38.51, -78.88], bbox: [-79.0845, 38.3473, -78.6737, 38.6734] },
            "russell": { name: "Russell County", fips: "167", mapCenter: [36.94, -82.1], bbox: [-82.3045, 36.7773, -81.8937, 37.1034] },
            "scott": { name: "Scott County", fips: "169", mapCenter: [36.72, -82.6], bbox: [-82.8045, 36.5573, -82.3937, 36.8834] },
            "shenandoah": { name: "Shenandoah County", fips: "171", mapCenter: [38.86, -78.57], bbox: [-78.7745, 38.6973, -78.3637, 39.0234] },
            "smyth": { name: "Smyth County", fips: "173", mapCenter: [36.85, -81.53], bbox: [-81.7345, 36.6873, -81.3237, 37.0134] },
            "southampton": { name: "Southampton County", fips: "175", mapCenter: [36.72, -77.11], bbox: [-77.3145, 36.5573, -76.9037, 36.8834] },
            "spotsylvania": { name: "Spotsylvania County", fips: "177", mapCenter: [38.18, -77.66], bbox: [-77.8645, 38.0173, -77.4537, 38.3434] },
            "stafford": { name: "Stafford County", fips: "179", mapCenter: [38.41, -77.45], bbox: [-77.6545, 38.2473, -77.2437, 38.5734] },
            "surry": { name: "Surry County", fips: "181", mapCenter: [37.12, -76.89], bbox: [-77.0945, 36.9573, -76.6837, 37.2834] },
            "sussex": { name: "Sussex County", fips: "183", mapCenter: [36.92, -77.27], bbox: [-77.4745, 36.7573, -77.0637, 37.0834] },
            "tazewell": { name: "Tazewell County", fips: "185", mapCenter: [37.13, -81.56], bbox: [-81.7645, 36.9673, -81.3537, 37.2934] },
            "warren": { name: "Warren County", fips: "187", mapCenter: [38.91, -78.2], bbox: [-78.4045, 38.7473, -77.9937, 39.0734] },
            "washington": { name: "Washington County", fips: "191", mapCenter: [36.72, -81.96], bbox: [-82.1645, 36.5573, -81.7537, 36.8834] },
            "westmoreland": { name: "Westmoreland County", fips: "193", mapCenter: [38.11, -76.8], bbox: [-77.0045, 37.9473, -76.5937, 38.2734] },
            "wise": { name: "Wise County", fips: "195", mapCenter: [36.97, -82.62], bbox: [-82.8245, 36.8073, -82.4137, 37.1334] },
            "wythe": { name: "Wythe County", fips: "197", mapCenter: [36.95, -81.08], bbox: [-81.2845, 36.7873, -80.8737, 37.1134] },
            "york": { name: "York County", fips: "199", mapCenter: [37.24, -76.55], bbox: [-76.7545, 37.0773, -76.3437, 37.4034] },
            "alexandria": { name: "Alexandria City", fips: "510", mapCenter: [38.82, -77.09], bbox: [-77.14, 38.79, -77.04, 38.85] },
            "bristol": { name: "Bristol City", fips: "520", mapCenter: [36.62, -82.17], bbox: [-82.22, 36.59, -82.12, 36.65] },
            "buena_vista": { name: "Buena Vista City", fips: "530", mapCenter: [37.73, -79.35], bbox: [-79.38, 37.71, -79.32, 37.75] },
            "charlottesville": { name: "Charlottesville City", fips: "540", mapCenter: [38.04, -78.48], bbox: [-78.52, 38.01, -78.44, 38.07] },
            "chesapeake": { name: "Chesapeake City", fips: "550", mapCenter: [36.68, -76.3], bbox: [-76.5, 36.5, -76.1, 36.9] },
            "colonial_heights": { name: "Colonial Heights City", fips: "570", mapCenter: [37.26, -77.4], bbox: [-77.43, 37.24, -77.37, 37.28] },
            "covington": { name: "Covington City", fips: "580", mapCenter: [37.78, -79.99], bbox: [-80.02, 37.76, -79.96, 37.8] },
            "danville": { name: "Danville City", fips: "590", mapCenter: [36.58, -79.41], bbox: [-79.46, 36.55, -79.36, 36.61] },
            "emporia": { name: "Emporia City", fips: "595", mapCenter: [36.69, -77.54], bbox: [-77.57, 36.67, -77.51, 36.71] },
            "fairfax_city": { name: "Fairfax City", fips: "600", mapCenter: [38.85, -77.3], bbox: [-77.33, 38.83, -77.27, 38.87] },
            "falls_church": { name: "Falls Church City", fips: "610", mapCenter: [38.88, -77.17], bbox: [-77.2, 38.86, -77.14, 38.9] },
            "franklin_city": { name: "Franklin City", fips: "620", mapCenter: [36.68, -76.93], bbox: [-76.96, 36.66, -76.9, 36.7] },
            "fredericksburg": { name: "Fredericksburg City", fips: "630", mapCenter: [38.3, -77.47], bbox: [-77.51, 38.28, -77.43, 38.32] },
            "galax": { name: "Galax City", fips: "640", mapCenter: [36.66, -80.92], bbox: [-80.95, 36.64, -80.89, 36.68] },
            "hampton": { name: "Hampton City", fips: "650", mapCenter: [37.05, -76.36], bbox: [-76.45, 37.0, -76.25, 37.1] },
            "harrisonburg": { name: "Harrisonburg City", fips: "660", mapCenter: [38.44, -78.87], bbox: [-78.91, 38.41, -78.83, 38.47] },
            "hopewell": { name: "Hopewell City", fips: "670", mapCenter: [37.29, -77.3], bbox: [-77.34, 37.27, -77.26, 37.31] },
            "lexington": { name: "Lexington City", fips: "678", mapCenter: [37.78, -79.44], bbox: [-79.47, 37.76, -79.41, 37.8] },
            "lynchburg": { name: "Lynchburg City", fips: "680", mapCenter: [37.4, -79.19], bbox: [-79.25, 37.35, -79.13, 37.45] },
            "manassas": { name: "Manassas City", fips: "683", mapCenter: [38.75, -77.48], bbox: [-77.52, 38.72, -77.44, 38.78] },
            "manassas_park": { name: "Manassas Park City", fips: "685", mapCenter: [38.77, -77.45], bbox: [-77.48, 38.75, -77.42, 38.79] },
            "martinsville": { name: "Martinsville City", fips: "690", mapCenter: [36.68, -79.86], bbox: [-79.9, 36.66, -79.82, 36.7] },
            "newport_news": { name: "Newport News City", fips: "700", mapCenter: [37.08, -76.52], bbox: [-76.65, 36.95, -76.4, 37.2] },
            "norfolk": { name: "Norfolk City", fips: "710", mapCenter: [36.89, -76.26], bbox: [-76.35, 36.8, -76.15, 37.0] },
            "norton": { name: "Norton City", fips: "720", mapCenter: [36.93, -82.63], bbox: [-82.66, 36.91, -82.6, 36.95] },
            "petersburg": { name: "Petersburg City", fips: "730", mapCenter: [37.2, -77.39], bbox: [-77.44, 37.17, -77.34, 37.23] },
            "poquoson": { name: "Poquoson City", fips: "735", mapCenter: [37.12, -76.35], bbox: [-76.4, 37.1, -76.3, 37.15] },
            "portsmouth": { name: "Portsmouth City", fips: "740", mapCenter: [36.84, -76.33], bbox: [-76.4, 36.8, -76.25, 36.9] },
            "radford": { name: "Radford City", fips: "750", mapCenter: [37.12, -80.56], bbox: [-80.6, 37.1, -80.52, 37.14] },
            "richmond_city": { name: "Richmond City", fips: "760", mapCenter: [37.54, -77.44], bbox: [-77.5775, 37.4464, -77.3853, 37.6011] },
            "roanoke_city": { name: "Roanoke City", fips: "770", mapCenter: [37.27, -79.94], bbox: [-80.0203, 37.2259, -79.8797, 37.3246] },
            "salem": { name: "Salem City", fips: "775", mapCenter: [37.29, -80.05], bbox: [-80.1085, 37.2579, -80.0053, 37.3285] },
            "staunton": { name: "Staunton City", fips: "790", mapCenter: [38.15, -79.07], bbox: [-79.1073, 38.1097, -79.02, 38.1839] },
            "suffolk": { name: "Suffolk City", fips: "800", mapCenter: [36.73, -76.58], bbox: [-76.923, 36.5453, -76.4038, 36.9384] },
            "virginia_beach": { name: "Virginia Beach City", fips: "810", mapCenter: [36.85, -75.98], bbox: [-76.2269, 36.5516, -75.8589, 36.933] },
            "waynesboro": { name: "Waynesboro City", fips: "820", mapCenter: [38.07, -78.89], bbox: [-78.9409, 38.0412, -78.8546, 38.1003] },
            "williamsburg": { name: "Williamsburg City", fips: "830", mapCenter: [37.27, -76.71], bbox: [-76.7421, 37.2498, -76.683, 37.2972] },
            "winchester": { name: "Winchester City", fips: "840", mapCenter: [39.19, -78.17], bbox: [-78.2074, 39.1383, -78.1252, 39.213] }
        };

        // Risk Matrix lookup
        const riskMatrix = {
            'high-high': 20,
            'high-moderate': 20,
            'high-low': 25,
            'moderate-high': 20,
            'moderate-moderate': 25,
            'moderate-low': 30,
            'low-high': 25,
            'low-moderate': 25,
            'low-low': 35
        };

        // Classification text mapping
        const classificationText = {
            'local': 'Local Street',
            'collector-minor': 'Minor Collector',
            'collector-major': 'Major Collector',
            'arterial-minor': 'Minor Arterial',
            'arterial-major': 'Major Arterial'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('studyDate').valueAsDate = new Date();
            document.getElementById('previewDate').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });

            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    updateCheckboxStyles();
                    updateAnalysis();
                });
            });

            document.querySelectorAll('input, textarea, select').forEach(input => {
                input.addEventListener('input', updatePreview);
            });
        });

        function toggleCheckbox(id) {
            const checkbox = document.getElementById(id);
            checkbox.checked = !checkbox.checked;
            updateCheckboxStyles();
            updateAnalysis();
        }

        function updateCheckboxStyles() {
            document.querySelectorAll('.checklist-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }
            });
        }

        function updateAnalysis() {
            // Calculate Conflict Density
            const conflictFactors = { high: 0, moderate: 0, low: 0 };

            // Modal Mixing - Pedestrian
            if (document.getElementById('noSidewalks').checked) conflictFactors.high += 2;
            if (document.getElementById('sidewalksOneSide').checked) conflictFactors.high += 1;
            if (document.getElementById('sidewalksAdjacent').checked) conflictFactors.moderate += 1;
            if (document.getElementById('sidewalksBuffered').checked) conflictFactors.low += 1;

            // Modal Mixing - Bicycle
            if (document.getElementById('noBikeFacilities').checked) conflictFactors.high += 2;
            if (document.getElementById('sharrows').checked) conflictFactors.high += 1;
            if (document.getElementById('markedBikeLane').checked) conflictFactors.moderate += 1;
            if (document.getElementById('bufferedBikeLane').checked) conflictFactors.low += 1;
            if (document.getElementById('protectedBikeLane').checked) conflictFactors.low += 2;

            // Crossing Point Density
            if (document.getElementById('highCrossingDensity').checked) conflictFactors.high += 2;
            if (document.getElementById('moderateCrossingDensity').checked) conflictFactors.moderate += 1;
            if (document.getElementById('lowCrossingDensity').checked) conflictFactors.low += 2;

            // Determine Conflict Density
            if (conflictFactors.high >= conflictFactors.moderate && conflictFactors.high >= conflictFactors.low) {
                analysisState.conflictDensity = 'high';
            } else if (conflictFactors.low > conflictFactors.high && conflictFactors.low > conflictFactors.moderate) {
                analysisState.conflictDensity = 'low';
            } else {
                analysisState.conflictDensity = 'moderate';
            }

            // Calculate Activity Level
            const activityFactors = { high: 0, moderate: 0, low: 0 };

            if (document.getElementById('downtown').checked) activityFactors.high += 3;
            if (document.getElementById('retailCorridor').checked) activityFactors.high += 2;
            if (document.getElementById('highDensity').checked) activityFactors.high += 2;
            if (document.getElementById('schoolZone').checked) activityFactors.high += 3;

            if (document.getElementById('moderateResidential').checked) activityFactors.moderate += 2;
            if (document.getElementById('lightRetail').checked) activityFactors.moderate += 1;
            if (document.getElementById('mixedUse').checked) activityFactors.moderate += 2;
            if (document.getElementById('hotelConference').checked) activityFactors.moderate += 1;

            if (document.getElementById('lowDensityIndustrial').checked) activityFactors.low += 2;
            if (document.getElementById('lowDensityResidential').checked) activityFactors.low += 2;
            if (document.getElementById('privateGated').checked) activityFactors.low += 2;

            if (activityFactors.high >= activityFactors.moderate && activityFactors.high >= activityFactors.low) {
                analysisState.activityLevel = 'high';
            } else if (activityFactors.low > activityFactors.high && activityFactors.low > activityFactors.moderate) {
                analysisState.activityLevel = 'low';
            } else {
                analysisState.activityLevel = 'moderate';
            }

            updateResultDisplays();
        }

        function updateResultDisplays() {
            const conflictResult = document.getElementById('conflictDensityResult');
            conflictResult.className = 'result-box result-' + analysisState.conflictDensity;
            conflictResult.innerHTML = `
                <h3>${analysisState.conflictDensity.toUpperCase()} CONFLICT DENSITY</h3>
                <p>Based on modal mixing and crossing point analysis</p>
            `;

            const activityResult = document.getElementById('activityLevelResult');
            activityResult.className = 'result-box result-' + analysisState.activityLevel;
            activityResult.innerHTML = `
                <h3>${analysisState.activityLevel.toUpperCase()} ACTIVITY</h3>
                <p>Based on land use context analysis</p>
            `;

            document.querySelectorAll('.risk-matrix-cell').forEach(cell => {
                cell.classList.remove('selected');
            });

            const selectedCell = document.getElementById(`cell-${analysisState.activityLevel}-${analysisState.conflictDensity}`);
            if (selectedCell) {
                selectedCell.classList.add('selected');
            }

            const key = `${analysisState.activityLevel}-${analysisState.conflictDensity}`;
            analysisState.recommendedSpeed = riskMatrix[key];
            document.getElementById('recommendedSpeed').textContent = analysisState.recommendedSpeed || '--';

            if (analysisState.recommendedSpeed) {
                document.getElementById('nactoSpeedDisplay').classList.add('selected');
            }
        }

        function updatePreview() {
            document.getElementById('previewTo').textContent = document.getElementById('memoTo').value || '--';
            document.getElementById('previewFrom').textContent = document.getElementById('memoFrom').value || '--';
            document.getElementById('previewSubject').textContent = document.getElementById('memoSubject').value || 'Speed Study Evaluation';
        }

        function calculateRecommendation() {
            const roadwayName = document.getElementById('roadwayName').value;
            const currentSpeedLimit = parseFloat(document.getElementById('currentSpeedLimit').value);
            const meanSpeed = parseFloat(document.getElementById('meanSpeed').value);
            const p85Speed = parseFloat(document.getElementById('p85Speed').value);
            const medianSpeed = parseFloat(document.getElementById('medianSpeed').value);

            if (!roadwayName) {
                alert('Please enter the roadway name.');
                return;
            }
            if (isNaN(p85Speed)) {
                alert('Please enter the 85th percentile speed.');
                return;
            }

            // Calculate 85th percentile method result
            const p85Rounded = Math.round(p85Speed / 5) * 5;
            analysisState.p85RecommendedSpeed = p85Rounded;
            document.getElementById('p85RecommendedSpeed').textContent = p85Rounded;

            // Update calculations tab
            document.getElementById('calcMeanSpeed').textContent = meanSpeed || '--';
            document.getElementById('calcP85Speed').textContent = p85Speed || '--';
            document.getElementById('calcP85Rounded').textContent = p85Rounded;
            document.getElementById('calcNACTOResult').textContent = analysisState.recommendedSpeed;

            generateCalculationsTable();
            updateRecommendationSummary();
            generateNACTOSummary();
            generateMemoPreview();
        }

        function generateCalculationsTable() {
            const calcTable = document.getElementById('calculationsTable');
            const currentSpeedLimit = document.getElementById('currentSpeedLimit').value || '--';
            const meanSpeed = document.getElementById('meanSpeed').value || '--';
            const medianSpeed = document.getElementById('medianSpeed').value || '--';
            const p85Speed = document.getElementById('p85Speed').value || '--';
            const minSpeed = document.getElementById('minSpeed').value || '--';
            const maxSpeed = document.getElementById('maxSpeed').value || '--';
            const stdDev = document.getElementById('stdDev').value || '--';
            const totalVehicles = document.getElementById('totalVehicles').value || '--';
            const avgDailyTraffic = document.getElementById('avgDailyTraffic').value || '--';
            const exceedingPosted = document.getElementById('exceedingPosted').value || '--';
            const paceSpeed = document.getElementById('paceSpeed').value || '--';

            calcTable.innerHTML = `
                <tr><td>Current Posted Speed Limit</td><td>${currentSpeedLimit} mph</td><td>Existing regulatory speed limit</td></tr>
                <tr><td>Mean Speed</td><td>${meanSpeed} mph</td><td>Average of all recorded vehicle speeds</td></tr>
                <tr><td>Median Speed</td><td>${medianSpeed} mph</td><td>Middle value of recorded speeds</td></tr>
                <tr><td>85th Percentile Speed</td><td>${p85Speed} mph</td><td>Speed at or below which 85% of vehicles travel</td></tr>
                <tr><td>Minimum Speed</td><td>${minSpeed} mph</td><td>Lowest recorded speed</td></tr>
                <tr><td>Maximum Speed</td><td>${maxSpeed} mph</td><td>Highest recorded speed</td></tr>
                <tr><td>Standard Deviation</td><td>${stdDev} mph</td><td>Speed variability measure</td></tr>
                <tr><td>Total Vehicles Surveyed</td><td>${totalVehicles}</td><td>Sample size</td></tr>
                <tr><td>Average Daily Traffic</td><td>${avgDailyTraffic} vpd</td><td>Typical daily volume</td></tr>
                <tr><td>% Exceeding Posted Limit</td><td>${exceedingPosted}%</td><td>Compliance indicator</td></tr>
                <tr><td>10 mph Pace</td><td>${paceSpeed} mph</td><td>Speed range with highest concentration</td></tr>
                <tr style="background: #e8f5e9;"><td><strong>85th Percentile Method Result</strong></td><td><strong>${analysisState.p85RecommendedSpeed} mph</strong></td><td>Rounded to nearest 5 mph (traditional method)</td></tr>
                <tr style="background: #dbeafe;"><td><strong>NACTO Risk Matrix Result</strong></td><td><strong>${analysisState.recommendedSpeed} mph</strong></td><td>${analysisState.activityLevel} activity + ${analysisState.conflictDensity} conflict density</td></tr>
            `;
        }

        function updateRecommendationSummary() {
            const roadwayName = document.getElementById('roadwayName').value;
            const summaryDiv = document.getElementById('recommendationSummary');

            let summaryText = `<strong>Analysis Summary for ${roadwayName}:</strong><br>`;
            summaryText += `‚Ä¢ Traditional 85th Percentile Method suggests: <strong>${analysisState.p85RecommendedSpeed} mph</strong><br>`;
            summaryText += `‚Ä¢ NACTO Safe Speed Study recommends: <strong>${analysisState.recommendedSpeed} mph</strong><br>`;
            summaryText += `‚Ä¢ Based on ${analysisState.conflictDensity.toUpperCase()} conflict density and ${analysisState.activityLevel.toUpperCase()} activity level`;

            summaryDiv.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>${summaryText}</span>
            `;
        }

        function getConflictDensityDescription() {
            const descriptions = {
                'high': 'High modal mixing with limited separation between modes and/or high crossing point density. Potential for vehicle-pedestrian or vehicle-bicycle conflicts is elevated.',
                'moderate': 'Some modal separation present with moderate crossing point density. Conflicts are possible but better managed through existing infrastructure.',
                'low': 'Good modal separation with protected facilities for pedestrians and bicyclists. Low crossing point density reduces conflict potential.'
            };
            return descriptions[analysisState.conflictDensity];
        }

        function getActivityLevelDescription() {
            const descriptions = {
                'high': 'High pedestrian and bicycle activity expected due to land use context (downtown, retail corridors, schools, high-density development).',
                'moderate': 'Moderate pedestrian and bicycle activity expected. Mixed use corridor with some retail and residential activity.',
                'low': 'Low pedestrian and bicycle activity expected. Primarily serves vehicle through-traffic with minimal destinations generating walking/biking trips.'
            };
            return descriptions[analysisState.activityLevel];
        }

        function generateNACTOSummary() {
            const content = `
                <div style="background: var(--gray-100); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                    <h5 style="color: var(--primary); margin-bottom: 10px;">Conflict Density Analysis Results</h5>
                    <p><strong>Result: ${analysisState.conflictDensity.toUpperCase()}</strong></p>
                    <p style="font-size: 0.9rem; margin-top: 8px;">${getConflictDensityDescription()}</p>
                </div>
                <div style="background: var(--gray-100); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                    <h5 style="color: var(--primary); margin-bottom: 10px;">Activity Level Analysis Results</h5>
                    <p><strong>Result: ${analysisState.activityLevel.toUpperCase()}</strong></p>
                    <p style="font-size: 0.9rem; margin-top: 8px;">${getActivityLevelDescription()}</p>
                </div>
                <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 20px; border-radius: 12px;">
                    <h5 style="margin-bottom: 10px;">Risk Matrix Result</h5>
                    <p style="font-size: 1.8rem; font-weight: bold;">${analysisState.recommendedSpeed} MPH</p>
                    <p style="font-size: 0.9rem; margin-top: 8px;">
                        Per NACTO City Limits methodology, streets with ${analysisState.activityLevel} activity and ${analysisState.conflictDensity} conflict density should have a speed limit of ${analysisState.recommendedSpeed} mph to minimize the risk of serious injury or death.
                    </p>
                </div>
            `;
            document.getElementById('nactoSummaryContent').innerHTML = content;
        }

        function generateRecommendationText() {
            const currentSpeedLimit = parseFloat(document.getElementById('currentSpeedLimit').value);
            const roadwayName = document.getElementById('roadwayName').value || 'this corridor';

            if (analysisState.recommendedSpeed === currentSpeedLimit) {
                return `I recommend that the speed limit remain posted at ${currentSpeedLimit} MPH on ${roadwayName}. This is consistent with both the NACTO Safe Speed Study methodology and provides for corridor consistency.`;
            } else if (analysisState.recommendedSpeed < currentSpeedLimit) {
                return `The NACTO methodology suggests a speed limit of ${analysisState.recommendedSpeed} MPH may be appropriate. However, considering corridor consistency, existing infrastructure, and engineering judgment, a comprehensive evaluation should determine whether a reduction to ${analysisState.recommendedSpeed} MPH is warranted on ${roadwayName}.`;
            } else {
                return `I recommend that the speed limit remain posted at ${currentSpeedLimit} MPH on ${roadwayName}. While the NACTO methodology indicates ${analysisState.recommendedSpeed} MPH may be acceptable, the current lower limit provides additional safety margin.`;
            }
        }

        function generateMemoPreview() {
            const roadwayName = document.getElementById('roadwayName').value || '[Roadway Name]';
            const fromLocation = document.getElementById('fromLocation').value;
            const toLocation = document.getElementById('toLocation').value;
            const corridorLength = document.getElementById('corridorLength').value || '--';
            const currentSpeedLimit = document.getElementById('currentSpeedLimit').value || '--';
            const roadwayClass = document.getElementById('roadwayClass').value;
            const meanSpeed = document.getElementById('meanSpeed').value || '--';
            const p85Speed = document.getElementById('p85Speed').value || '--';
            const avgDailyTraffic = document.getElementById('avgDailyTraffic').value || '--';
            const pedestrianVolume = document.getElementById('pedestrianVolume').value;
            const crashCount = document.getElementById('crashCount').value;
            const crashNarrative = document.getElementById('crashNarrative').value;
            const additionalNotes = document.getElementById('additionalNotes').value;

            let locationText = '';
            if (fromLocation) locationText += ` from ${fromLocation}`;
            if (toLocation) locationText += ` to ${toLocation}`;

            let memoBody = `
                <p>In response to concerns about the current posted speed limit on ${roadwayName}${locationText}, we have investigated this roadway and would like to offer the following for your consideration.</p>

                <p style="margin-top: 15px;"><strong>The following characteristics are currently present on ${roadwayName}:</strong></p>
                <ul style="margin-left: 25px; margin-top: 10px;">
                    <li>The public segment of ${roadwayName} is approximately ${corridorLength} mile(s) long.</li>
                    <li>The roadway segment is currently posted at ${currentSpeedLimit} mph${roadwayClass ? ' and is classified as a ' + classificationText[roadwayClass] : ''}.</li>
                    <li>The 85th percentile speed of the corridor was collected at ${p85Speed} mph.</li>
                    <li>The mean speed on the corridor is ${meanSpeed} mph.</li>
                    <li>The average daily traffic is ${avgDailyTraffic} vehicles per day.</li>
                    ${pedestrianVolume ? `<li>Pedestrian activity volume: ${pedestrianVolume} per day.</li>` : ''}
                    ${crashCount ? `<li>Total crashes recorded: ${crashCount} (study period).</li>` : ''}
                </ul>

                ${crashNarrative ? `<p style="margin-top: 15px;"><strong>Crash Pattern Analysis:</strong> ${crashNarrative}</p>` : ''}

                <p style="margin-top: 15px;"><strong>NACTO City Limits Analysis:</strong></p>
                <p>Using the NACTO City Limits methodology consistent with the MUTCD 11th Edition, the following analysis was conducted:</p>
                <ul style="margin-left: 25px; margin-top: 10px;">
                    <li><strong>Conflict Density:</strong> ${analysisState.conflictDensity.toUpperCase()}</li>
                    <li><strong>Activity Level:</strong> ${analysisState.activityLevel.toUpperCase()}</li>
                </ul>

                <p style="margin-top: 15px;"><strong>Speed Limit Recommendations:</strong></p>
                <ul style="margin-left: 25px; margin-top: 10px;">
                    <li>Traditional 85th Percentile Method: ${analysisState.p85RecommendedSpeed} mph</li>
                    <li>NACTO Safe Speed Study (Risk Matrix): <strong>${analysisState.recommendedSpeed} mph</strong></li>
                </ul>

                ${additionalNotes ? `<p style="margin-top: 15px;"><strong>Additional Notes:</strong> ${additionalNotes}</p>` : ''}

                <p style="margin-top: 15px;"><strong>Recommendation:</strong></p>
                <p>${generateRecommendationText()}</p>

                <p style="margin-top: 20px;">If you need additional information, please let me know.</p>
            `;

            document.getElementById('previewBody').innerHTML = memoBody;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        function clearAll() {
            if (!confirm('Are you sure you want to clear all data? This cannot be undone.')) return;

            // Clear all text inputs
            document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(input => {
                input.value = '';
            });

            // Clear all checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });

            // Reset select
            document.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });

            // Reset date
            document.getElementById('studyDate').valueAsDate = new Date();

            // Reset analysis state
            analysisState = {
                conflictDensity: 'moderate',
                activityLevel: 'moderate',
                recommendedSpeed: null,
                p85RecommendedSpeed: null
            };

            // Update displays
            updateCheckboxStyles();
            updateAnalysis();
            updatePreview();

            // Reset recommendation displays
            document.getElementById('recommendedSpeed').textContent = '--';
            document.getElementById('p85RecommendedSpeed').textContent = '--';
            document.getElementById('calcMeanSpeed').textContent = '--';
            document.getElementById('calcP85Speed').textContent = '--';
            document.getElementById('calcP85Rounded').textContent = '--';
            document.getElementById('calcNACTOResult').textContent = '--';
            document.getElementById('nactoSpeedDisplay').classList.remove('selected');

            document.getElementById('calculationsTable').innerHTML = '<tr><td colspan="3">Run analysis to see calculations</td></tr>';
            document.getElementById('nactoSummaryContent').innerHTML = '<p>Complete the analysis checklists to see the NACTO methodology summary.</p>';
            document.getElementById('previewBody').innerHTML = '<p>Complete the form and click "Calculate Recommendation" to generate the memo preview.</p>';
            document.getElementById('recommendationSummary').innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span><strong>Analysis Summary:</strong> Complete all required fields and checklists to generate the speed limit recommendation.</span>
            `;
        }

        function generateWordDoc() {
            const roadwayName = document.getElementById('roadwayName').value || 'Speed Study';
            const jurisdiction = document.getElementById('jurisdiction').value || '';
            const memoTo = document.getElementById('memoTo').value || '[Recipient]';
            const memoFrom = document.getElementById('memoFrom').value || '[Department]';
            const memoSubject = document.getElementById('memoSubject').value || roadwayName + ' Speed Study Evaluation';
            const studyDate = document.getElementById('studyDate').value ?
                new Date(document.getElementById('studyDate').value).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) :
                new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const signatureName = document.getElementById('signatureName').value || '';
            const ccList = document.getElementById('ccList').value || '';

            // Generate Word-compatible HTML
            const wordContent = `
<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta charset="utf-8">
<title>${roadwayName} Speed Study</title>
<style>
    body { font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.5; margin: 1in; }
    h1 { text-align: center; font-size: 14pt; margin-bottom: 5px; }
    h2 { font-size: 12pt; margin-top: 15px; }
    table.header { width: 100%; border-bottom: 2px solid black; margin-bottom: 20px; padding-bottom: 10px; }
    table.header td { padding: 3px 0; vertical-align: top; }
    table.header td:first-child { width: 100px; font-weight: bold; }
    ul { margin-left: 30px; }
    li { margin-bottom: 5px; }
    .signature { margin-top: 40px; }
</style>
</head>
<body>
<h1>${jurisdiction ? jurisdiction.toUpperCase() : 'INTER-OFFICE MEMORANDUM'}</h1>
${jurisdiction ? '<h1 style="font-size: 12pt;">INTER-OFFICE MEMORANDUM</h1>' : ''}
<hr style="border: 1px solid black; margin: 15px 0;">

<table class="header">
    <tr><td>TO:</td><td>${memoTo}</td></tr>
    <tr><td>FROM:</td><td>${memoFrom}</td></tr>
    <tr><td>SUBJECT:</td><td>${memoSubject}</td></tr>
    <tr><td>DATE:</td><td>${studyDate}</td></tr>
</table>

${document.getElementById('previewBody').innerHTML}

<div class="signature">
<p>${signatureName}</p>
</div>

${ccList ? `<p style="margin-top: 30px;"><strong>pc:</strong> ${ccList}</p>` : ''}

</body>
</html>
            `;

            const blob = new Blob([wordContent], { type: 'application/msword' });
            saveAs(blob, `${roadwayName.replace(/[^a-z0-9]/gi, '_')}_Speed_Study_Memo.doc`);
        }

        function printFullReport() {
            const roadwayName = document.getElementById('roadwayName').value || 'Speed Study Report';
            const jurisdiction = document.getElementById('jurisdiction').value || '';
            const studyDate = document.getElementById('studyDate').value ?
                new Date(document.getElementById('studyDate').value).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) :
                new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Collect all data
            const data = collectAllData();

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
<!DOCTYPE html>
<html>
<head>
    <title>${roadwayName} - Complete Speed Study Report</title>
    <style>
        body { font-family: 'Times New Roman', Georgia, serif; font-size: 11pt; line-height: 1.6; margin: 0.75in; color: #333; }
        h1 { text-align: center; font-size: 18pt; color: #1a5f7a; margin-bottom: 5px; border-bottom: 3px solid #1a5f7a; padding-bottom: 10px; }
        h2 { font-size: 14pt; color: #1a5f7a; margin-top: 25px; border-bottom: 2px solid #c38154; padding-bottom: 5px; }
        h3 { font-size: 12pt; color: #57837b; margin-top: 15px; }
        .header-info { text-align: center; margin-bottom: 20px; color: #666; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #1a5f7a; color: white; font-weight: bold; }
        tr:nth-child(even) { background: #f5f5f5; }
        .highlight { background: #e8f5e9 !important; font-weight: bold; }
        .page-break { page-break-before: always; }
        .appendix-header { background: linear-gradient(135deg, #1a5f7a, #134a5e); color: white; padding: 12px 20px; margin: 25px 0 15px 0; font-size: 14pt; font-weight: bold; }
        .legal-notice { background: #fef3c7; border: 2px solid #f59e0b; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .risk-matrix { display: grid; grid-template-columns: 100px repeat(3, 1fr); gap: 3px; margin: 20px 0; }
        .risk-cell { padding: 12px; text-align: center; font-weight: bold; border: 1px solid #ddd; }
        .risk-header { background: #1a5f7a; color: white; }
        .risk-label { background: #57837b; color: white; }
        .risk-20 { background: #ff6b6b; color: white; }
        .risk-25 { background: #fb923c; color: white; }
        .risk-30 { background: #fbbf24; color: #333; }
        .risk-35 { background: #4ade80; color: white; }
        .risk-selected { border: 3px solid #000 !important; font-size: 14pt; }
        .signature-block { margin-top: 50px; }
        .footer { text-align: center; font-size: 9pt; color: #666; margin-top: 30px; border-top: 1px solid #ddd; padding-top: 10px; }
        ul { margin-left: 25px; }
        li { margin-bottom: 8px; }
        @media print {
            body { margin: 0.5in; }
            .page-break { page-break-before: always; }
        }
    </style>
</head>
<body>

<!-- COVER PAGE -->
<div style="text-align: center; padding-top: 100px;">
    <h1 style="font-size: 24pt; border: none;">SPEED STUDY REPORT</h1>
    <h2 style="font-size: 18pt; color: #333; border: none;">${roadwayName}</h2>
    ${data.fromLocation || data.toLocation ? `<p style="font-size: 14pt;">${data.fromLocation || ''} ${data.fromLocation && data.toLocation ? 'to' : ''} ${data.toLocation || ''}</p>` : ''}
    <p style="font-size: 12pt; margin-top: 50px;">${jurisdiction}</p>
    <p style="font-size: 12pt;">Study Date: ${studyDate}</p>
    <p style="font-size: 12pt; margin-top: 30px;">Prepared Using NACTO City Limits Methodology</p>
    <p style="font-size: 10pt;">Consistent with MUTCD 11th Edition (2023)</p>
</div>

<div class="page-break"></div>

<!-- TABLE OF CONTENTS -->
<h1>Table of Contents</h1>
<ul style="list-style-type: none; margin-left: 0;">
    <li>1. Executive Summary ............................ 3</li>
    <li>2. Study Results ............................ 4</li>
    <li>3. NACTO City Limits Analysis ............................ 5</li>
    <li>4. Speed Limit Recommendation ............................ 6</li>
    <li>Appendix A: Speed Data Summary ............................ 7</li>
    <li>Appendix B: NACTO Methodology Reference ............................ 8</li>
    <li>Appendix C: Legal Review Documentation ............................ 9</li>
</ul>

<div class="page-break"></div>

<!-- SECTION 1: EXECUTIVE SUMMARY -->
<h1>1. Executive Summary</h1>
<p>This report presents the findings of a speed study conducted on <strong>${roadwayName}</strong>${data.fromLocation ? ' from ' + data.fromLocation : ''}${data.toLocation ? ' to ' + data.toLocation : ''}. The study was conducted using the NACTO City Limits methodology, which is compliant with the 11th Edition of the Manual on Uniform Traffic Control Devices (MUTCD).</p>

<h3>Key Findings:</h3>
<table>
    <tr><th>Parameter</th><th>Value</th></tr>
    <tr><td>Current Posted Speed Limit</td><td>${data.currentSpeedLimit || '--'} mph</td></tr>
    <tr><td>85th Percentile Speed</td><td>${data.p85Speed || '--'} mph</td></tr>
    <tr><td>Mean Speed</td><td>${data.meanSpeed || '--'} mph</td></tr>
    <tr><td>NACTO Conflict Density</td><td>${analysisState.conflictDensity.toUpperCase()}</td></tr>
    <tr><td>NACTO Activity Level</td><td>${analysisState.activityLevel.toUpperCase()}</td></tr>
    <tr class="highlight"><td>Traditional 85th Percentile Method Result</td><td>${analysisState.p85RecommendedSpeed || '--'} mph</td></tr>
    <tr class="highlight"><td>NACTO Risk Matrix Recommendation</td><td>${analysisState.recommendedSpeed || '--'} mph</td></tr>
</table>

<div class="page-break"></div>

<!-- SECTION 2: STUDY RESULTS -->
<h1>2. Study Results</h1>

<h2>2.1 Corridor Characteristics</h2>
<table>
    <tr><th>Characteristic</th><th>Value</th></tr>
    <tr><td>Roadway Name</td><td>${roadwayName}</td></tr>
    <tr><td>Corridor Length</td><td>${data.corridorLength || '--'} miles</td></tr>
    <tr><td>Functional Classification</td><td>${data.roadwayClass ? classificationText[data.roadwayClass] : '--'}</td></tr>
    <tr><td>Current Posted Speed Limit</td><td>${data.currentSpeedLimit || '--'} mph</td></tr>
    <tr><td>Number of Traffic Signals</td><td>${data.signalCount || '--'}</td></tr>
</table>

<h2>2.2 Speed Data Summary</h2>
<table>
    <tr><th>Speed Metric</th><th>Value</th><th>Description</th></tr>
    <tr><td>Mean Speed</td><td>${data.meanSpeed || '--'} mph</td><td>Average of all recorded speeds</td></tr>
    <tr><td>Median Speed</td><td>${data.medianSpeed || '--'} mph</td><td>Middle value of speed distribution</td></tr>
    <tr><td>85th Percentile Speed</td><td>${data.p85Speed || '--'} mph</td><td>Speed at or below which 85% travel</td></tr>
    <tr><td>Minimum Speed</td><td>${data.minSpeed || '--'} mph</td><td>Lowest recorded speed</td></tr>
    <tr><td>Maximum Speed</td><td>${data.maxSpeed || '--'} mph</td><td>Highest recorded speed</td></tr>
    <tr><td>Standard Deviation</td><td>${data.stdDev || '--'} mph</td><td>Speed variability measure</td></tr>
    <tr><td>10 mph Pace</td><td>${data.paceSpeed || '--'} mph</td><td>Range with highest concentration</td></tr>
    <tr><td>% Exceeding Posted Limit</td><td>${data.exceedingPosted || '--'}%</td><td>Non-compliance rate</td></tr>
</table>

<h2>2.3 Volume Data</h2>
<table>
    <tr><th>Volume Metric</th><th>Value</th></tr>
    <tr><td>Total Vehicles Surveyed</td><td>${data.totalVehicles || '--'}</td></tr>
    <tr><td>Average Daily Traffic (ADT)</td><td>${data.avgDailyTraffic || '--'} vpd</td></tr>
    <tr><td>Pedestrian Volume (per day)</td><td>${data.pedestrianVolume || '--'}</td></tr>
    <tr><td>Bicycle Volume (per day)</td><td>${data.bicycleVolume || '--'}</td></tr>
</table>

${data.crashCount ? `
<h2>2.4 Crash History</h2>
<p><strong>Total Crashes:</strong> ${data.crashCount}</p>
${data.crashNarrative ? `<p><strong>Crash Pattern Notes:</strong> ${data.crashNarrative}</p>` : ''}
` : ''}

<div class="page-break"></div>

<!-- SECTION 3: NACTO ANALYSIS -->
<h1>3. NACTO City Limits Analysis</h1>

<h2>3.1 Conflict Density Analysis</h2>
<p><strong>Result: ${analysisState.conflictDensity.toUpperCase()}</strong></p>
<p>${getConflictDensityDescription()}</p>

<h3>Factors Considered:</h3>
<ul>
    <li><strong>Modal Mixing - Pedestrian Facilities:</strong> ${getCheckedItems(['noSidewalks', 'sidewalksOneSide', 'sidewalksAdjacent', 'sidewalksBuffered'])}</li>
    <li><strong>Modal Mixing - Bicycle Facilities:</strong> ${getCheckedItems(['noBikeFacilities', 'sharrows', 'markedBikeLane', 'bufferedBikeLane', 'protectedBikeLane'])}</li>
    <li><strong>Crossing Point Density:</strong> ${getCheckedItems(['highCrossingDensity', 'moderateCrossingDensity', 'lowCrossingDensity'])}</li>
</ul>

<h2>3.2 Activity Level Analysis</h2>
<p><strong>Result: ${analysisState.activityLevel.toUpperCase()}</strong></p>
<p>${getActivityLevelDescription()}</p>

<h3>Factors Considered:</h3>
<ul>
    <li><strong>High Activity Indicators:</strong> ${getCheckedItems(['downtown', 'retailCorridor', 'highDensity', 'schoolZone'])}</li>
    <li><strong>Moderate Activity Indicators:</strong> ${getCheckedItems(['moderateResidential', 'lightRetail', 'mixedUse', 'hotelConference'])}</li>
    <li><strong>Low Activity Indicators:</strong> ${getCheckedItems(['lowDensityIndustrial', 'lowDensityResidential', 'privateGated'])}</li>
</ul>

<h2>3.3 Risk Matrix</h2>
<p>The NACTO Risk Matrix combines conflict density and activity level to determine the recommended speed limit:</p>

<div class="risk-matrix">
    <div class="risk-cell"></div>
    <div class="risk-cell risk-header">HIGH CONFLICT</div>
    <div class="risk-cell risk-header">MODERATE CONFLICT</div>
    <div class="risk-cell risk-header">LOW CONFLICT</div>
    
    <div class="risk-cell risk-label">HIGH ACTIVITY</div>
    <div class="risk-cell risk-20 ${analysisState.activityLevel === 'high' && analysisState.conflictDensity === 'high' ? 'risk-selected' : ''}">20 MPH</div>
    <div class="risk-cell risk-20 ${analysisState.activityLevel === 'high' && analysisState.conflictDensity === 'moderate' ? 'risk-selected' : ''}">20 MPH</div>
    <div class="risk-cell risk-25 ${analysisState.activityLevel === 'high' && analysisState.conflictDensity === 'low' ? 'risk-selected' : ''}">25 MPH</div>
    
    <div class="risk-cell risk-label">MODERATE ACTIVITY</div>
    <div class="risk-cell risk-20 ${analysisState.activityLevel === 'moderate' && analysisState.conflictDensity === 'high' ? 'risk-selected' : ''}">20 MPH</div>
    <div class="risk-cell risk-25 ${analysisState.activityLevel === 'moderate' && analysisState.conflictDensity === 'moderate' ? 'risk-selected' : ''}">25 MPH</div>
    <div class="risk-cell risk-30 ${analysisState.activityLevel === 'moderate' && analysisState.conflictDensity === 'low' ? 'risk-selected' : ''}">30 MPH</div>
    
    <div class="risk-cell risk-label">LOW ACTIVITY</div>
    <div class="risk-cell risk-25 ${analysisState.activityLevel === 'low' && analysisState.conflictDensity === 'high' ? 'risk-selected' : ''}">25 MPH</div>
    <div class="risk-cell risk-25 ${analysisState.activityLevel === 'low' && analysisState.conflictDensity === 'moderate' ? 'risk-selected' : ''}">25 MPH</div>
    <div class="risk-cell risk-35 ${analysisState.activityLevel === 'low' && analysisState.conflictDensity === 'low' ? 'risk-selected' : ''}">35 MPH</div>
</div>

<div class="page-break"></div>

<!-- SECTION 4: RECOMMENDATION -->
<h1>4. Speed Limit Recommendation</h1>

<h2>4.1 Method Comparison</h2>
<table>
    <tr><th>Method</th><th>Recommended Speed Limit</th><th>Basis</th></tr>
    <tr><td>Traditional 85th Percentile Method</td><td>${analysisState.p85RecommendedSpeed || '--'} mph</td><td>85th percentile speed rounded to nearest 5 mph</td></tr>
    <tr class="highlight"><td>NACTO Safe Speed Study</td><td>${analysisState.recommendedSpeed || '--'} mph</td><td>${analysisState.activityLevel} activity + ${analysisState.conflictDensity} conflict density</td></tr>
</table>

<h2>4.2 Engineering Recommendation</h2>
<p>${generateRecommendationText()}</p>

${data.additionalNotes ? `
<h2>4.3 Additional Considerations</h2>
<p>${data.additionalNotes}</p>
` : ''}

<div class="signature-block">
    <p>____________________________________</p>
    <p>${data.signatureName || 'Prepared By'}</p>
    <p>Date: ${studyDate}</p>
</div>

${data.ccList ? `<p style="margin-top: 30px;"><strong>Distribution:</strong> ${data.ccList}</p>` : ''}

<div class="page-break"></div>

<!-- APPENDIX A -->
<div class="appendix-header">APPENDIX A: Speed Data Summary</div>

<h3>Complete Speed Statistics</h3>
<table>
    <tr><th>Statistic</th><th>Value</th><th>Unit</th></tr>
    <tr><td>Sample Size</td><td>${data.totalVehicles || '--'}</td><td>vehicles</td></tr>
    <tr><td>Mean Speed</td><td>${data.meanSpeed || '--'}</td><td>mph</td></tr>
    <tr><td>Median Speed</td><td>${data.medianSpeed || '--'}</td><td>mph</td></tr>
    <tr><td>85th Percentile Speed</td><td>${data.p85Speed || '--'}</td><td>mph</td></tr>
    <tr><td>Minimum Speed</td><td>${data.minSpeed || '--'}</td><td>mph</td></tr>
    <tr><td>Maximum Speed</td><td>${data.maxSpeed || '--'}</td><td>mph</td></tr>
    <tr><td>Standard Deviation</td><td>${data.stdDev || '--'}</td><td>mph</td></tr>
    <tr><td>10 mph Pace</td><td>${data.paceSpeed || '--'}</td><td>mph</td></tr>
    <tr><td>Posted Speed Limit</td><td>${data.currentSpeedLimit || '--'}</td><td>mph</td></tr>
    <tr><td>% Exceeding Posted</td><td>${data.exceedingPosted || '--'}</td><td>%</td></tr>
</table>

<h3>85th Percentile Method Calculation</h3>
<p><strong>Formula:</strong> Round 85th percentile speed to nearest 5 mph</p>
<p><strong>Calculation:</strong> ${data.p85Speed || '--'} mph ‚Üí ${analysisState.p85RecommendedSpeed || '--'} mph</p>

<div class="page-break"></div>

<!-- APPENDIX B -->
<div class="appendix-header">APPENDIX B: NACTO Methodology Reference</div>

<h3>About NACTO City Limits</h3>
<p>NACTO City Limits (2020) provides city practitioners with guidance on how to strategically set speed limits on urban streets to reduce traffic fatalities and injuries using a Safe System Approach.</p>

<h3>MUTCD 11th Edition Compliance</h3>
<p>The 11th Edition of the MUTCD (2023) now requires an engineering study that considers roadway context for setting speed zones. Jurisdictions are able to use speed limit setting tools and methods such as expert systems and those consistent with the safe system approach as part of the required engineering study.</p>

<h3>Conflict Density Factors</h3>
<ul>
    <li><strong>Modal Mixing:</strong> Physical separation between people walking, biking, and motor vehicles</li>
    <li><strong>Crossing Point Density:</strong> Number of intersections, driveways, and crossing opportunities per distance</li>
</ul>

<h3>Activity Level Factors</h3>
<ul>
    <li><strong>High Activity:</strong> Downtown, retail corridors, schools, high-density areas</li>
    <li><strong>Moderate Activity:</strong> Mixed-use corridors, moderate density residential/commercial</li>
    <li><strong>Low Activity:</strong> Industrial areas, low-density residential, private access roads</li>
</ul>

<h3>Risk Matrix Basis</h3>
<p>The risk matrix is based on the principle that higher conflict density and higher activity levels require lower speed limits to minimize the risk of fatal and serious injuries in crashes.</p>

<div class="page-break"></div>

<!-- APPENDIX C -->
<div class="appendix-header">APPENDIX C: Legal Review Documentation</div>

<div class="legal-notice">
    <h3>‚ö†Ô∏è Important Notice</h3>
    <p>This speed study has been prepared in accordance with accepted engineering practices and is consistent with the requirements of the Manual on Uniform Traffic Control Devices (MUTCD) 11th Edition.</p>
</div>

<h3>Engineering Study Certification</h3>
<p>This engineering study was conducted in accordance with:</p>
<ul>
    <li>Manual on Uniform Traffic Control Devices (MUTCD) - 11th Edition (2023)</li>
    <li>NACTO City Limits: Setting Safe Speed Limits on Urban Streets (2020)</li>
    <li>Institute of Transportation Engineers (ITE) Traffic Engineering Handbook</li>
    <li>Highway Safety Manual</li>
</ul>

<h3>Data Collection Methods</h3>
<p>Speed data was collected using appropriate traffic engineering equipment and methodologies. The sample size of ${data.totalVehicles || '[N/A]'} vehicles provides a statistically valid basis for the speed analysis.</p>

<h3>Regulatory Authority</h3>
<p>Speed limits shall be established in accordance with state and local statutes governing the setting of regulatory speed zones. This engineering study provides the technical justification for any proposed speed limit changes.</p>

<h3>Professional Responsibility</h3>
<p>The analysis and recommendations contained in this report represent the professional engineering judgment of the preparer based on the data and conditions observed at the time of the study.</p>

<div class="signature-block">
    <p>Professional Engineer Certification (if applicable):</p>
    <p>____________________________________</p>
    <p>Signature & Seal</p>
    <p>Date: _______________</p>
</div>

<div class="footer">
    <p>Speed Study Report | ${roadwayName} | ${studyDate}</p>
    <p>Prepared using NACTO City Limits Methodology | MUTCD 11th Edition Compliant</p>
    <p>Page generated: ${new Date().toLocaleString()}</p>
</div>

</body>
</html>
            `);

            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function getCheckedItems(checkboxIds) {
            const labels = {
                'noSidewalks': 'No sidewalks',
                'sidewalksOneSide': 'Sidewalk on one side only',
                'sidewalksAdjacent': 'Sidewalks adjacent to traffic',
                'sidewalksBuffered': 'Buffered sidewalks',
                'noBikeFacilities': 'No bike facilities',
                'sharrows': 'Sharrows',
                'markedBikeLane': 'Marked bike lane',
                'bufferedBikeLane': 'Buffered bike lane',
                'protectedBikeLane': 'Protected bike lane',
                'highCrossingDensity': '‚â•3 crossings per ¬º mile',
                'moderateCrossingDensity': '1-3 crossings per ¬º mile',
                'lowCrossingDensity': 'Few crossings per ¬º mile',
                'downtown': 'Downtown/CBD',
                'retailCorridor': 'Retail corridor',
                'highDensity': 'High density area',
                'schoolZone': 'School zone',
                'moderateResidential': 'Moderate density residential',
                'lightRetail': 'Light retail',
                'mixedUse': 'Mixed use corridor',
                'hotelConference': 'Hotel/conference center',
                'lowDensityIndustrial': 'Low density industrial',
                'lowDensityResidential': 'Low density residential',
                'privateGated': 'Private gated community'
            };

            const checked = checkboxIds.filter(id => document.getElementById(id)?.checked);
            if (checked.length === 0) return 'None selected';
            return checked.map(id => labels[id] || id).join(', ');
        }

        function collectAllData() {
            return {
                roadwayName: document.getElementById('roadwayName').value,
                studyDate: document.getElementById('studyDate').value,
                fromLocation: document.getElementById('fromLocation').value,
                toLocation: document.getElementById('toLocation').value,
                corridorLength: document.getElementById('corridorLength').value,
                currentSpeedLimit: document.getElementById('currentSpeedLimit').value,
                roadwayClass: document.getElementById('roadwayClass').value,
                jurisdiction: document.getElementById('jurisdiction').value,
                meanSpeed: document.getElementById('meanSpeed').value,
                medianSpeed: document.getElementById('medianSpeed').value,
                p85Speed: document.getElementById('p85Speed').value,
                minSpeed: document.getElementById('minSpeed').value,
                maxSpeed: document.getElementById('maxSpeed').value,
                stdDev: document.getElementById('stdDev').value,
                totalVehicles: document.getElementById('totalVehicles').value,
                avgDailyTraffic: document.getElementById('avgDailyTraffic').value,
                exceedingPosted: document.getElementById('exceedingPosted').value,
                paceSpeed: document.getElementById('paceSpeed').value,
                pedestrianVolume: document.getElementById('pedestrianVolume').value,
                bicycleVolume: document.getElementById('bicycleVolume').value,
                crashCount: document.getElementById('crashCount').value,
                signalCount: document.getElementById('signalCount').value,
                crashNarrative: document.getElementById('crashNarrative').value,
                memoTo: document.getElementById('memoTo').value,
                memoFrom: document.getElementById('memoFrom').value,
                memoSubject: document.getElementById('memoSubject').value,
                additionalNotes: document.getElementById('additionalNotes').value,
                signatureName: document.getElementById('signatureName').value,
                ccList: document.getElementById('ccList').value
            };
        }

        function saveProject() {
            const data = collectAllData();
            data.checkboxes = {};
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                data.checkboxes[cb.id] = cb.checked;
            });
            data.analysisState = analysisState;

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const filename = (data.roadwayName || 'speed_study').replace(/[^a-z0-9]/gi, '_') + '_project.json';
            saveAs(blob, filename);
        }

        function loadProject() {
            document.getElementById('fileInput').click();
        }

        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    Object.keys(data).forEach(key => {
                        if (key === 'checkboxes') {
                            Object.keys(data.checkboxes).forEach(cbId => {
                                const cb = document.getElementById(cbId);
                                if (cb) cb.checked = data.checkboxes[cbId];
                            });
                        } else if (key === 'analysisState') {
                            analysisState = data.analysisState;
                        } else {
                            const el = document.getElementById(key);
                            if (el) el.value = data[key];
                        }
                    });

                    updateCheckboxStyles();
                    updateResultDisplays();
                    updatePreview();

                    if (data.p85Speed) {
                        calculateRecommendation();
                    }

                    alert('Project loaded successfully!');
                } catch (err) {
                    alert('Error loading project file: ' + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        // Initialize
        updateAnalysis();
    </script>

    <!-- Leaflet Map Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Esri Leaflet for VDOT ArcGIS Integration -->
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet-vector@4.2.3/dist/esri-leaflet-vector.js"></script>

    <script>
        // Embedded Map Variables
        let embeddedMap;
        let speedCluster;
        let stopYieldCluster;
        let drawnItems;
        let currentDrawHandler;
        let speedData = [];
        let stopYieldData = [];
        let baseLayers = {};
        let currentBaseLayer;
        let tigerwebLayer;

        // VDOT API Endpoints
        const VDOT_SERVICES = {
            SPEED_LIMITS: 'https://services.arcgis.com/p5v98VHDX9Atv3l7/arcgis/rest/services/VDOT_Posted_Speed_Limits/FeatureServer/0',
            TRAFFIC_VOLUME: 'https://services.arcgis.com/p5v98VHDX9Atv3l7/arcgis/rest/services/VDOT_Traffic_Volume_2024/FeatureServer/0',
            CRASHES: 'https://services.arcgis.com/p5v98VHDX9Atv3l7/arcgis/rest/services/Full_Crash/FeatureServer/0',
            SIDEWALKS: 'https://services.arcgis.com/p5v98VHDX9Atv3l7/arcgis/rest/services/VDOT_Sidewalk_Inventory/FeatureServer/0',
            BIKE_PED: 'https://services.arcgis.com/p5v98VHDX9Atv3l7/arcgis/rest/services/VDOTBikeandPedestrian24HrCounts20112017/FeatureServer/0'
        };

        let vaBoundaryLayer;

        // Initialize Embedded Map
        function initEmbeddedMap() {
            embeddedMap = L.map('embeddedMap', {
                center: [37.59, -77.605],
                zoom: 13,
                zoomControl: true
            });

            // Define Base Layers
            baseLayers = {
                osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }),
                esri: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
                })
            };

            // Set default base layer
            currentBaseLayer = baseLayers.osm;
            currentBaseLayer.addTo(embeddedMap);

            // Load Virginia Boundary for masking/restriction
            const vaBoundaryUrl = 'https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/State_County/MapServer/0/query?where=STATE=\'51\'&outFields=NAME,STATE&f=geojson&outSR=4326';
            fetch(vaBoundaryUrl)
                .then(response => response.json())
                .then(data => {
                    vaBoundaryLayer = L.geoJSON(data, {
                        style: {
                            color: '#1a5f7a',
                            weight: 2,
                            fillOpacity: 0.05,
                            dashArray: '5, 5'
                        }
                    }).addTo(embeddedMap);

                    // Restrict map to Virginia bounds
                    if (vaBoundaryLayer.getBounds().isValid()) {
                        embeddedMap.setMaxBounds(vaBoundaryLayer.getBounds().pad(0.1));
                    }
                })
                .catch(err => {
                    console.error('Error loading VA boundary from remote:', err);
                    // Fallback: try local file if remote fails
                    fetch('virginia_boundary.json')
                        .then(res => res.json())
                        .then(data => {
                            vaBoundaryLayer = L.geoJSON(data, { style: { color: '#1a5f7a', weight: 2, fillOpacity: 0.05, dashArray: '5, 5' } }).addTo(embeddedMap);
                            if (vaBoundaryLayer.getBounds().isValid()) embeddedMap.setMaxBounds(vaBoundaryLayer.getBounds().pad(0.1));
                        }).catch(e => console.error('Local boundary fallback failed:', e));
                });

            // Initialize marker clusters
            speedCluster = L.markerClusterGroup({
                chunkedLoading: true,
                maxClusterRadius: 50,
                iconCreateFunction: function (cluster) {
                    const count = cluster.getChildCount();
                    let size = count > 50 ? 'large' : (count > 20 ? 'medium' : 'small');
                    return L.divIcon({
                        html: `<div style="background: linear-gradient(135deg, #22c55e, #ef4444); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><span>${count}</span></div>`,
                        className: '',
                        iconSize: L.point(40, 40)
                    });
                }
            });

            stopYieldCluster = L.markerClusterGroup({
                chunkedLoading: true,
                maxClusterRadius: 50,
                iconCreateFunction: function (cluster) {
                    const count = cluster.getChildCount();
                    return L.divIcon({
                        html: `<div style="background: linear-gradient(135deg, #dc2626, #eab308); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><span>${count}</span></div>`,
                        className: '',
                        iconSize: L.point(40, 40)
                    });
                }
            });

            // Initialize drawn items layer
            drawnItems = new L.FeatureGroup();
            embeddedMap.addLayer(drawnItems);

            // Load data
            loadMapData();

            // Handle draw events
            embeddedMap.on(L.Draw.Event.CREATED, function (e) {
                drawnItems.addLayer(e.layer);
                deactivateTools();
                updateSelectionCount();
            });

            // VDOT Click-to-Populate Handler
            embeddedMap.on('click', function (e) {
                if (currentDrawHandler) return;

                // Process click

                // If a county is selected, we check bounds but with a generous padding
                const countyKey = document.getElementById('countySelector').value;
                if (countyKey) {
                    const county = JURISDICTIONS[countyKey];
                    const bounds = L.latLngBounds([county.bbox[1], county.bbox[0]], [county.bbox[3], county.bbox[2]]).pad(0.2);
                    if (!bounds.contains(e.latlng)) {
                        // Instead of a hard block, we just warn in console and proceed 
                        // as the user might be clicking near the border
                        console.warn(`Click slightly outside hardcoded ${county.name} bounds`);
                    }
                }

                // Add a temporary ripple/marker to show where the user clicked
                const clickMarker = L.circleMarker(e.latlng, {
                    radius: 10,
                    color: '#1a5f7a',
                    fillColor: '#1a5f7a',
                    fillOpacity: 0.3,
                    weight: 2
                }).addTo(embeddedMap);

                setTimeout(() => embeddedMap.removeLayer(clickMarker), 1000);

                fetchVDOTData(e.latlng);
            });

            // Handle zoom events for scale-dependent layers
            embeddedMap.on('zoomend', function () {
                const zoom = embeddedMap.getZoom();
                const warning = document.getElementById('crashScaleWarning');
                if (warning) {
                    // VDOT Crash layer typically disappears above ~1:50,000 scale (zoom < 13-14)
                    if (document.getElementById('vdotCrashToggle').checked && zoom < 13) {
                        warning.style.display = 'block';
                    } else {
                        warning.style.display = 'none';
                    }
                }
            });

            // Initialize VDOT Layers (inside init to ensure L.esri is loaded)
            if (typeof L.esri !== 'undefined') {
                window.vdotTrafficLayer = L.esri.featureLayer({
                    url: VDOT_SERVICES.TRAFFIC_VOLUME,
                    style: function () { return { color: '#3b82f6', weight: 3 }; }
                });

                window.vdotCrashLayer = L.esri.featureLayer({
                    url: VDOT_SERVICES.CRASHES,
                    pointToLayer: function (geojson, latlng) {
                        return L.circleMarker(latlng, {
                            radius: 5,
                            fillColor: '#ef4444',
                            color: '#fff',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                    }
                });

                window.vdotSidewalkLayer = L.esri.featureLayer({
                    url: VDOT_SERVICES.SIDEWALKS,
                    style: function () { return { color: '#fbbf24', weight: 2 }; }
                });

                window.vdotSpeedLimitLayer = L.esri.featureLayer({
                    url: VDOT_SERVICES.SPEED_LIMITS,
                    style: function () { return { color: '#10b981', weight: 3 }; }
                });

                window.vdotBikePedLayer = L.esri.featureLayer({
                    url: VDOT_SERVICES.BIKE_PED,
                    pointToLayer: function (geojson, latlng) {
                        return L.circleMarker(latlng, {
                            radius: 6,
                            fillColor: '#8b5cf6',
                            color: '#fff',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                    }
                });
            }

            // Initialize Tigerweb Layer
            if (typeof L.esri !== 'undefined') {
                tigerwebLayer = L.esri.dynamicMapLayer({
                    url: TIGERWEB_CONFIG.baseUrl,
                    layers: [TIGERWEB_CONFIG.layers.counties, TIGERWEB_CONFIG.layers.tracts],
                    opacity: 0.7
                });
            }

            // Populate County Selector
            populateCountySelector();
        }

        function populateCountySelector() {
            const selector = document.getElementById('countySelector');
            if (!selector) return;
            const sortedKeys = Object.keys(JURISDICTIONS).sort((a, b) => JURISDICTIONS[a].name.localeCompare(JURISDICTIONS[b].name));

            sortedKeys.forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = JURISDICTIONS[key].name;
                selector.appendChild(opt);
            });
        }

        function filterVDOTLayers(countyKey, vdotCode = null) {
            const layers = [
                { layer: window.vdotTrafficLayer, fields: ['FROM_JURISDICTION', 'TO_JURISDICTION', 'ROUTE_COMMON_NAME'] },
                { layer: window.vdotCrashLayer, fields: ['JURIS_CODE'] },
                { layer: window.vdotSidewalkLayer, fields: ['RouteName'] },
                { layer: window.vdotSpeedLimitLayer, fields: ['FROM_JURISDICTION', 'TO_JURISDICTION', 'ROUTE_COMMON_NAME'] },
                { layer: window.vdotBikePedLayer, fields: ['Jurisdicti'] }
            ];

            if (!countyKey) {
                layers.forEach(l => {
                    if (l.layer) l.layer.setWhere('1=1');
                });
                return;
            }

            const county = JURISDICTIONS[countyKey];
            if (!county) return;

            const jurName = county.name.replace(/ (County|City)$/i, '').toUpperCase();

            layers.forEach(l => {
                if (l.layer) {
                    if (l.layer === window.vdotCrashLayer) {
                        if (vdotCode) {
                            l.layer.setWhere(`JURIS_CODE = '${vdotCode}'`);
                        } else {
                            // Fallback to name-based if code failed, but use a safer field if possible
                            l.layer.setWhere('1=1');
                        }
                    } else if (l.layer === window.vdotSidewalkLayer) {
                        if (vdotCode) {
                            const paddedCode = String(vdotCode).padStart(3, '0');
                            l.layer.setWhere(`RouteName LIKE 'R-VA${paddedCode}%'`);
                        } else {
                            l.layer.setWhere('1=1');
                        }
                    } else if (l.fields.length > 0) {
                        const whereClause = l.fields.map(f => `${f} LIKE '%${jurName}%'`).join(' OR ');
                        l.layer.setWhere(whereClause);
                    } else {
                        l.layer.setWhere('1=1');
                    }
                }
            });
        }

        function zoomToCounty(countyKey) {
            if (!countyKey) {
                // Reset to Virginia bounds
                if (vaBoundaryLayer) {
                    embeddedMap.fitBounds(vaBoundaryLayer.getBounds());
                }
                if (tigerwebLayer) {
                    tigerwebLayer.setLayerDefs({});
                }
                // Reset markers
                filterMarkersByCounty(null);
                // Reset VDOT layers
                filterVDOTLayers(null);
                // Clear jurisdiction field
                const jurField = document.getElementById('jurisdiction');
                if (jurField) jurField.value = '';
                return;
            }

            const county = JURISDICTIONS[countyKey];
            if (county && county.bbox) {
                // Leaflet bbox is [lat, lng, lat, lng] or [[lat, lng], [lat, lng]]
                // Tigerweb bbox is [minX, minY, maxX, maxY] which is [lng, lat, lng, lat]
                const bounds = [
                    [county.bbox[1], county.bbox[0]],
                    [county.bbox[3], county.bbox[2]]
                ];
                embeddedMap.fitBounds(bounds);

                // Filter Tigerweb layer to show only this county
                if (tigerwebLayer) {
                    const layerDefs = {};
                    layerDefs[TIGERWEB_CONFIG.layers.counties] = `COUNTY = '${county.fips}' AND STATE = '${TIGERWEB_CONFIG.stateFips}'`;
                    tigerwebLayer.setLayerDefs(layerDefs);

                    // If Tigerweb is not enabled, enable it
                    if (!document.getElementById('tigerwebToggle').checked) {
                        document.getElementById('tigerwebToggle').checked = true;
                        tigerwebLayer.addTo(embeddedMap);
                    }
                }

                // Filter markers only for this county
                filterMarkersByCounty(countyKey);

                // Filter VDOT layers only for this county
                // We fetch the VDOT Jurisdiction Code dynamically to ensure precise filtering
                if (typeof L.esri !== 'undefined') {
                    L.esri.query({ url: VDOT_SERVICES.CRASHES })
                        .nearby(county.mapCenter, 10000)
                        .run((error, featureCollection) => {
                            let vdotCode = null;
                            if (!error && featureCollection && featureCollection.features && featureCollection.features.length > 0) {
                                // Get the most frequent JURIS_CODE in the vicinity
                                const codes = featureCollection.features.map(f => f.properties.JURIS_CODE).filter(c => c);
                                if (codes.length > 0) {
                                    vdotCode = codes.sort((a, b) =>
                                        codes.filter(v => v === a).length - codes.filter(v => v === b).length
                                    ).pop();
                                }
                            }
                            filterVDOTLayers(countyKey, vdotCode);
                        });
                } else {
                    filterVDOTLayers(countyKey);
                }

                // Update form field
                updateField('jurisdiction', county.name, 'Selection');
            }
        }

        function fetchVDOTDataManual() {
            const center = embeddedMap.getCenter();
            fetchVDOTData(center);
        }

        function changeBaseMap(type) {
            if (baseLayers[type]) {
                embeddedMap.removeLayer(currentBaseLayer);
                currentBaseLayer = baseLayers[type];
                currentBaseLayer.addTo(embeddedMap);

                // Ensure boundary layer stays on top if it exists
                if (vaBoundaryLayer) {
                    vaBoundaryLayer.bringToFront();
                }
            }
        }

        async function fetchVDOTData(latlng) {
            const overlay = document.getElementById('mapLoadingOverlay');
            overlay.style.display = 'flex';

            try {
                // 1. Query Speed Limits & Road Name
                try {
                    const speedResult = await queryEsriService(VDOT_SERVICES.SPEED_LIMITS, latlng, 150);
                    if (speedResult) {
                        updateField('roadwayName', speedResult.ROUTE_COMMON_NAME, 'VDOT');
                        updateField('currentSpeedLimit', speedResult.CAR_SPEED_LIMIT, 'VDOT');
                        updateField('jurisdiction', speedResult.FROM_JURISDICTION, 'VDOT');
                        updateField('corridorLength', speedResult.LENGTH ? speedResult.LENGTH.toFixed(2) : null, 'VDOT');

                        if (speedResult.RTE_TYPE_NM) {
                            const type = speedResult.RTE_TYPE_NM.toLowerCase();
                            let mappedClass = '';
                            if (type.includes('interstate') || type.includes('primary')) mappedClass = 'arterial-major';
                            else if (type.includes('secondary')) mappedClass = 'collector-major';
                            else if (type.includes('urban')) mappedClass = 'arterial-minor';
                            else mappedClass = 'local';
                            updateField('roadwayClass', mappedClass, 'VDOT');
                        }
                    }
                } catch (e) { console.warn('Speed limit query failed', e); }

                // 2. Query Traffic Volume
                try {
                    const volumeResult = await queryEsriService(VDOT_SERVICES.TRAFFIC_VOLUME, latlng, 150);
                    if (volumeResult) {
                        updateField('avgDailyTraffic', volumeResult.ADT, 'VDOT');
                        updateField('fromLocation', volumeResult.START_LABEL, 'VDOT');
                        updateField('toLocation', volumeResult.END_LABEL, 'VDOT');
                    }
                } catch (e) { console.warn('Traffic volume query failed', e); }

                // 3. Query Bike/Ped Counts
                try {
                    const bikePedResult = await queryEsriService(VDOT_SERVICES.BIKE_PED, latlng, 200);
                    if (bikePedResult) {
                        updateField('bicycleVolume', bikePedResult.Bicyclists, 'VDOT');
                        updateField('pedestrianVolume', bikePedResult.Pedestrian, 'VDOT');
                    }
                } catch (e) { console.warn('Bike/Ped query failed', e); }

                // 4. Query Crashes (Count nearby)
                try {
                    const crashCollection = await queryEsriService(VDOT_SERVICES.CRASHES, latlng, 200, true);
                    if (crashCollection) {
                        updateField('crashCount', crashCollection.features.length, 'VDOT');
                    }
                } catch (e) { console.warn('Crash query failed', e); }

                // 5. Check Sidewalks for Checkboxes
                try {
                    const sidewalkResult = await queryEsriService(VDOT_SERVICES.SIDEWALKS, latlng, 100);
                    const noSidewalksCheck = document.getElementById('noSidewalks');
                    if (noSidewalksCheck) noSidewalksCheck.checked = !sidewalkResult;
                } catch (e) { console.warn('Sidewalk query failed', e); }

                // Always update coordinates as a fallback
                updateField('fromLocation', `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`, 'Map');

            } catch (err) {
                console.error('Critical error in fetchVDOTData:', err);
            } finally {
                overlay.style.display = 'none';
            }
        }

        function queryEsriService(url, latlng, buffer = 50, returnFull = false) {
            return new Promise((resolve, reject) => {
                const query = L.esri.query({ url: url }).nearby(latlng, buffer);

                // We rely on the spatial query (.nearby) and the click-bounds check 
                // in the click handler. Attribute filtering here often fails due to 
                // inconsistent field names across different VDOT services.

                query.run((error, featureCollection) => {
                    if (error) {
                        reject(error);
                    } else if (featureCollection && featureCollection.features && featureCollection.features.length > 0) {
                        resolve(returnFull ? featureCollection : featureCollection.features[0].properties);
                    } else {
                        resolve(null);
                    }
                });
            });
        }

        function updateField(id, value, source) {
            const el = document.getElementById(id);
            if (el && value !== undefined && value !== null) {
                el.value = value;

                // Add/Update VDOT Badge
                let badge = el.parentElement.querySelector('.vdot-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'vdot-badge';
                    el.parentElement.appendChild(badge);
                }
                badge.innerHTML = `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg> ${source}`;

                // Trigger change event for any listeners
                el.dispatchEvent(new Event('change'));
            }
        }

        function isPointInLayer(latlng, layer) {
            let inside = false;
            layer.eachLayer(l => {
                if (l.getBounds().contains(latlng)) {
                    if (l instanceof L.Polygon) {
                        const poly = l.getLatLngs()[0];
                        if (Array.isArray(poly[0])) {
                            poly.forEach(part => {
                                if (isPointInPolygon(latlng, part)) inside = true;
                            });
                        } else {
                            if (isPointInPolygon(latlng, poly)) inside = true;
                        }
                    } else {
                        inside = true;
                    }
                }
            });
            return inside;
        }

        function isPointInPolygon(latlng, poly) {
            let inside = false;
            for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
                const xi = poly[i].lat, yi = poly[i].lng;
                const xj = poly[j].lat, yj = poly[j].lng;
                if (((yi > latlng.lng) !== (yj > latlng.lng)) &&
                    (latlng.lat < (xj - xi) * (latlng.lng - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            return inside;
        }

        function createMapMarker(type, speed = null) {
            if (type === 'speed') {
                // MUTCD R2-1 Speed Limit Sign - White rectangle with black border
                return L.divIcon({
                    className: '',
                    html: `
                        <div style="
                            width: 32px;
                            height: 40px;
                            background: white;
                            border: 2px solid black;
                            border-radius: 3px;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            font-family: 'Highway Gothic', Arial, sans-serif;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
                            cursor: pointer;
                        ">
                            <div style="font-size: 5px; font-weight: bold; color: black; line-height: 1; margin-bottom: 1px;">SPEED</div>
                            <div style="font-size: 5px; font-weight: bold; color: black; line-height: 1; margin-bottom: 2px;">LIMIT</div>
                            <div style="font-size: 16px; font-weight: bold; color: black; line-height: 1;">${speed}</div>
                        </div>
                    `,
                    iconSize: [32, 40],
                    iconAnchor: [16, 20]
                });
            } else if (type === 'stop') {
                // MUTCD R1-1 Stop Sign - Red octagon with white text
                return L.divIcon({
                    className: '',
                    html: `
                        <div style="
                            width: 34px;
                            height: 34px;
                            background: #cc0000;
                            clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
                            cursor: pointer;
                        ">
                            <div style="
                                width: 30px;
                                height: 30px;
                                background: #cc0000;
                                border: 2px solid white;
                                clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <span style="color: white; font-size: 8px; font-weight: bold; font-family: 'Highway Gothic', Arial, sans-serif;">STOP</span>
                            </div>
                        </div>
                    `,
                    iconSize: [34, 34],
                    iconAnchor: [17, 17]
                });
            } else {
                // MUTCD R1-2 Yield Sign - Red/white triangle pointing down
                return L.divIcon({
                    className: '',
                    html: `
                        <div style="
                            width: 36px;
                            height: 32px;
                            position: relative;
                            cursor: pointer;
                            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
                        ">
                            <div style="
                                width: 0;
                                height: 0;
                                border-left: 18px solid transparent;
                                border-right: 18px solid transparent;
                                border-top: 32px solid #cc0000;
                                position: absolute;
                                top: 0;
                                left: 0;
                            "></div>
                            <div style="
                                width: 0;
                                height: 0;
                                border-left: 14px solid transparent;
                                border-right: 14px solid transparent;
                                border-top: 25px solid white;
                                position: absolute;
                                top: 3px;
                                left: 4px;
                            "></div>
                            <div style="
                                position: absolute;
                                top: 8px;
                                left: 50%;
                                transform: translateX(-50%);
                                color: #cc0000;
                                font-size: 6px;
                                font-weight: bold;
                                font-family: 'Highway Gothic', Arial, sans-serif;
                            ">YIELD</div>
                        </div>
                    `,
                    iconSize: [36, 32],
                    iconAnchor: [18, 16]
                });
            }
        }

        function createMapPopup(data, type) {
            let signIcon, title, signColor;

            if (type === 'speed') {
                signColor = '#1a5f7a';
                title = `Speed Limit ${data.speed} MPH`;
                signIcon = `
                    <div style="width: 40px; height: 50px; background: white; border: 2px solid black; border-radius: 3px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="font-size: 6px; font-weight: bold; color: black;">SPEED</div>
                        <div style="font-size: 6px; font-weight: bold; color: black;">LIMIT</div>
                        <div style="font-size: 20px; font-weight: bold; color: black;">${data.speed}</div>
                    </div>
                `;
            } else if (type === 'stop') {
                signColor = '#cc0000';
                title = 'STOP Sign (R1-1)';
                signIcon = `
                    <div style="width: 44px; height: 44px; background: #cc0000; clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%); display: flex; align-items: center; justify-content: center;">
                        <div style="width: 38px; height: 38px; border: 2px solid white; clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%); display: flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-size: 10px; font-weight: bold;">STOP</span>
                        </div>
                    </div>
                `;
            } else {
                signColor = '#cc0000';
                title = 'YIELD Sign (R1-2)';
                signIcon = `
                    <div style="width: 44px; height: 40px; position: relative;">
                        <div style="width: 0; height: 0; border-left: 22px solid transparent; border-right: 22px solid transparent; border-top: 40px solid #cc0000; position: absolute;"></div>
                        <div style="width: 0; height: 0; border-left: 17px solid transparent; border-right: 17px solid transparent; border-top: 31px solid white; position: absolute; top: 4px; left: 5px;"></div>
                        <div style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color: #cc0000; font-size: 8px; font-weight: bold;">YIELD</div>
                    </div>
                `;
            }

            return `
                <div style="min-width: 220px; font-family: 'Segoe UI', Arial, sans-serif;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid #e5e5e5;">
                        ${signIcon}
                        <div>
                            <div style="font-weight: 700; color: ${signColor}; font-size: 14px;">${title}</div>
                            <div style="font-size: 11px; color: #666; margin-top: 2px;">MUTCD Compliant Sign</div>
                        </div>
                    </div>
                    <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 6px 0; color: #666; font-weight: 500;">MUTCD Code</td>
                            <td style="padding: 6px 0; text-align: right; font-weight: 600; color: #333;">${data.mutcd || 'N/A'}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 6px 0; color: #666; font-weight: 500;">Sign Class</td>
                            <td style="padding: 6px 0; text-align: right; font-weight: 600; color: #333;">${data.name || 'N/A'}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 6px 0; color: #666; font-weight: 500;">First Observed</td>
                            <td style="padding: 6px 0; text-align: right; font-weight: 600; color: #333;">${data.first_seen || 'N/A'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 6px 0; color: #666; font-weight: 500;">Coordinates</td>
                            <td style="padding: 6px 0; text-align: right; font-weight: 600; color: #333; font-size: 11px;">${parseFloat(data.lat).toFixed(6)}, ${parseFloat(data.lon).toFixed(6)}</td>
                        </tr>
                    </table>
                </div>
            `;
        }

        function addSpeedMarker(row) {
            try {
                const lat = parseFloat(row.lat);
                const lon = parseFloat(row.lon);
                const speed = parseInt(row.speed) || 25;
                if (!isNaN(lat) && !isNaN(lon)) {
                    const marker = L.marker([lat, lon], { icon: createMapMarker('speed', speed) });
                    marker.bindPopup(createMapPopup(row, 'speed'));
                    marker.data = row;
                    speedCluster.addLayer(marker);
                } else {
                    console.warn('Invalid coordinates for speed marker:', row);
                }
            } catch (e) {
                console.error('Error adding speed marker:', e, row);
            }
        }

        function addStopYieldMarker(row) {
            try {
                const lat = parseFloat(row.lat);
                const lon = parseFloat(row.lon);
                const type = row.name === 'YIELD' ? 'yield' : 'stop';
                if (!isNaN(lat) && !isNaN(lon)) {
                    const marker = L.marker([lat, lon], { icon: createMapMarker(type) });
                    marker.bindPopup(createMapPopup(row, type));
                    marker.data = row;
                    stopYieldCluster.addLayer(marker);
                } else {
                    console.warn('Invalid coordinates for stop/yield marker:', row);
                }
            } catch (e) {
                console.error('Error adding stop/yield marker:', e, row);
            }
        }

        function filterMarkersByCounty(countyKey) {
            speedCluster.clearLayers();
            stopYieldCluster.clearLayers();

            if (!countyKey) {
                speedData.forEach(row => addSpeedMarker(row));
                stopYieldData.forEach(row => addStopYieldMarker(row));
                const total = speedData.length + stopYieldData.length;
                document.getElementById('mapSignCount').textContent = `${total} signs loaded`;
                return;
            }

            const county = JURISDICTIONS[countyKey];
            const [minLng, minLat, maxLng, maxLat] = county.bbox;

            let count = 0;
            speedData.forEach(row => {
                const lat = parseFloat(row.lat);
                const lon = parseFloat(row.lon);
                if (lat >= minLat && lat <= maxLat && lon >= minLng && lon <= maxLng) {
                    addSpeedMarker(row);
                    count++;
                }
            });

            stopYieldData.forEach(row => {
                const lat = parseFloat(row.lat);
                const lon = parseFloat(row.lon);
                if (lat >= minLat && lat <= maxLat && lon >= minLng && lon <= maxLng) {
                    addStopYieldMarker(row);
                    count++;
                }
            });

            document.getElementById('mapSignCount').textContent = `${count} signs in ${county.name}`;
        }

        function loadMapData() {
            let loaded = 0;
            console.log('Starting to load map data from CSVs...');

            const parseOptions = {
                download: true,
                header: true,
                skipEmptyLines: true,
                trimHeaders: true,
                delimiter: ",",
                error: function (err, file) {
                    console.error(`Error parsing ${file}:`, err);
                    loaded++;
                    if (loaded >= 2) finishMapLoad();
                }
            };

            // Load Speed Limits
            Papa.parse('data/Speed limit.csv', {
                ...parseOptions,
                complete: function (results) {
                    console.log(`Speed limit CSV loaded. Rows: ${results.data.length}`);
                    if (results.data.length > 0) {
                        console.log('Speed limit first row sample:', results.data[0]);
                        console.log('Available headers:', Object.keys(results.data[0]));
                    }
                    if (results.errors && results.errors.length > 0) {
                        console.warn('Speed limit parse errors:', results.errors);
                    }
                    speedData = results.data.filter(r => r.lat && r.lon);
                    console.log(`Filtered speed markers: ${speedData.length}`);

                    speedData.forEach(row => addSpeedMarker(row));

                    if (document.getElementById('speedLayerToggle').checked) {
                        embeddedMap.addLayer(speedCluster);
                    }

                    loaded++;
                    if (loaded >= 2) finishMapLoad();
                }
            });

            // Load Stop and Yield
            Papa.parse('data/Stop and Yield.csv', {
                ...parseOptions,
                complete: function (results) {
                    console.log(`Stop and Yield CSV loaded. Rows: ${results.data.length}`);
                    if (results.data.length > 0) {
                        console.log('Stop and Yield first row sample:', results.data[0]);
                        console.log('Available headers:', Object.keys(results.data[0]));
                    }
                    if (results.errors && results.errors.length > 0) {
                        console.warn('Stop and Yield parse errors:', results.errors);
                    }
                    stopYieldData = results.data.filter(r => r.lat && r.lon);
                    console.log(`Filtered stop/yield markers: ${stopYieldData.length}`);

                    stopYieldData.forEach(row => addStopYieldMarker(row));

                    if (document.getElementById('stopYieldLayerToggle').checked) {
                        embeddedMap.addLayer(stopYieldCluster);
                    }

                    loaded++;
                    if (loaded >= 2) finishMapLoad();
                }
            });
        }

        function finishMapLoad() {
            const total = speedData.length + stopYieldData.length;
            console.log(`Finishing map load. Total signs: ${total}`);
            document.getElementById('mapSignCount').textContent = `${total} signs loaded`;

            // Fit bounds
            try {
                const speedBounds = speedCluster.getBounds();
                const stopBounds = stopYieldCluster.getBounds();

                let combinedBounds = null;
                if (speedBounds.isValid()) combinedBounds = speedBounds;
                if (stopBounds.isValid()) {
                    if (combinedBounds) combinedBounds.extend(stopBounds);
                    else combinedBounds = stopBounds;
                }

                if (combinedBounds && combinedBounds.isValid()) {
                    console.log('Fitting map to combined bounds:', combinedBounds);
                    embeddedMap.fitBounds(combinedBounds, { padding: [30, 30] });
                } else {
                    console.warn('No valid bounds found for markers.');
                }
            } catch (e) {
                console.error('Error fitting bounds:', e);
            }
        }

        // Layer toggles
        document.getElementById('speedLayerToggle').addEventListener('change', function () {
            if (this.checked) {
                embeddedMap.addLayer(speedCluster);
            } else {
                embeddedMap.removeLayer(speedCluster);
            }
            updateSelectionCount();
        });

        document.getElementById('stopYieldLayerToggle').addEventListener('change', function () {
            if (this.checked) {
                embeddedMap.addLayer(stopYieldCluster);
            } else {
                embeddedMap.removeLayer(stopYieldCluster);
            }
            updateSelectionCount();
        });

        document.getElementById('vdotTrafficToggle').addEventListener('change', function () {
            if (!window.vdotTrafficLayer) return;
            if (this.checked) {
                window.vdotTrafficLayer.addTo(embeddedMap);
            } else {
                embeddedMap.removeLayer(window.vdotTrafficLayer);
            }
        });

        document.getElementById('vdotCrashToggle').addEventListener('change', function () {
            if (!window.vdotCrashLayer) return;
            if (this.checked) {
                window.vdotCrashLayer.addTo(embeddedMap);
            } else {
                embeddedMap.removeLayer(window.vdotCrashLayer);
            }
        });

        document.getElementById('vdotSidewalkToggle').addEventListener('change', function () {
            if (!window.vdotSidewalkLayer) return;
            if (this.checked) {
                window.vdotSidewalkLayer.addTo(embeddedMap);
            } else {
                embeddedMap.removeLayer(window.vdotSidewalkLayer);
            }
        });

        document.getElementById('vdotSpeedToggle').addEventListener('change', function () {
            if (!window.vdotSpeedLimitLayer) return;
            if (this.checked) {
                window.vdotSpeedLimitLayer.addTo(embeddedMap);
            } else {
                embeddedMap.removeLayer(window.vdotSpeedLimitLayer);
            }
        });

        document.getElementById('vdotBikePedToggle').addEventListener('change', function () {
            if (!window.vdotBikePedLayer) return;
            if (this.checked) {
                window.vdotBikePedLayer.addTo(embeddedMap);
            } else {
                embeddedMap.removeLayer(window.vdotBikePedLayer);
            }
        });

        document.getElementById('tigerwebToggle').addEventListener('change', function () {
            if (!tigerwebLayer) return;
            if (this.checked) {
                tigerwebLayer.addTo(embeddedMap);
            } else {
                embeddedMap.removeLayer(tigerwebLayer);
            }
        });

        // Drawing tools
        function deactivateTools() {
            if (currentDrawHandler) {
                currentDrawHandler.disable();
                currentDrawHandler = null;
            }
            document.querySelectorAll('.map-tool-btn').forEach(btn => {
                btn.style.background = 'white';
                btn.style.borderColor = '#e2e8f0';
            });
        }

        function activatePolygonDraw() {
            deactivateTools();
            document.getElementById('polygonBtn').style.background = '#e0f2fe';
            document.getElementById('polygonBtn').style.borderColor = '#1a5f7a';
            currentDrawHandler = new L.Draw.Polygon(embeddedMap, {
                shapeOptions: { color: '#1a5f7a', fillColor: '#1a5f7a', fillOpacity: 0.2, weight: 3 }
            });
            currentDrawHandler.enable();
        }

        function activateCircleDraw() {
            deactivateTools();
            document.getElementById('circleBtn').style.background = '#e0f2fe';
            document.getElementById('circleBtn').style.borderColor = '#1a5f7a';
            currentDrawHandler = new L.Draw.Circle(embeddedMap, {
                shapeOptions: { color: '#1a5f7a', fillColor: '#1a5f7a', fillOpacity: 0.2, weight: 3 }
            });
            currentDrawHandler.enable();
        }

        function activateRectangleDraw() {
            deactivateTools();
            document.getElementById('rectangleBtn').style.background = '#e0f2fe';
            document.getElementById('rectangleBtn').style.borderColor = '#1a5f7a';
            currentDrawHandler = new L.Draw.Rectangle(embeddedMap, {
                shapeOptions: { color: '#1a5f7a', fillColor: '#1a5f7a', fillOpacity: 0.2, weight: 3 }
            });
            currentDrawHandler.enable();
        }

        function clearAllSelections() {
            drawnItems.clearLayers();
            deactivateTools();
            document.getElementById('selectionInfo').style.display = 'none';
        }

        function updateSelectionCount() {
            if (drawnItems.getLayers().length === 0) {
                document.getElementById('selectionInfo').style.display = 'none';
                return;
            }

            let speedCount = 0, stopCount = 0;

            drawnItems.eachLayer(function (shape) {
                if (document.getElementById('speedLayerToggle').checked) {
                    speedCluster.eachLayer(function (marker) {
                        if (isInShape(marker, shape)) speedCount++;
                    });
                }
                if (document.getElementById('stopYieldLayerToggle').checked) {
                    stopYieldCluster.eachLayer(function (marker) {
                        if (isInShape(marker, shape)) stopCount++;
                    });
                }
            });

            const info = document.getElementById('selectionInfo');
            info.textContent = `Selected: ${speedCount} speed, ${stopCount} stop/yield`;
            info.style.display = 'block';
        }

        function isInShape(marker, shape) {
            const latlng = marker.getLatLng();
            if (shape instanceof L.Circle) {
                return shape.getLatLng().distanceTo(latlng) <= shape.getRadius();
            } else if (shape instanceof L.Polygon || shape instanceof L.Rectangle) {
                const poly = shape.getLatLngs()[0];
                let inside = false;
                for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
                    const xi = poly[i].lat, yi = poly[i].lng;
                    const xj = poly[j].lat, yj = poly[j].lng;
                    if (((yi > latlng.lng) !== (yj > latlng.lng)) &&
                        (latlng.lat < (xj - xi) * (latlng.lng - yi) / (yj - yi) + xi)) {
                        inside = !inside;
                    }
                }
                return inside;
            }
            return false;
        }

        // Initialize map when DOM is ready
        document.addEventListener('DOMContentLoaded', initEmbeddedMap);
    </script>
</body>

</html>